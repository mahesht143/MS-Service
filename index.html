<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS Stocks Manager - Inventory Tracking with Login</title>
    <style>
        :root {
            --primary: #6366F1;
            --success: #14B8A6;
            --warning: #F97316;
            --danger: #EF4444;
            --dark: #1F2937;
            --light: #F9FAFB;
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
            --sidebar-top: #0369a1;
            --sidebar-bottom: #0c4a6e;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: var(--dark);
            font-size: 16px;
        }
        #mainApp {
            display: none; !important;
            min-height: 100vh;
            flex-direction: row;
        }
        /* SIDEBAR NAVIGATION */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--sidebar-top) 0%, var(--sidebar-bottom) 100%);
            padding: 24px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 0 20px 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            margin-bottom: 20px;
        }
        .sidebar-title {
            color: white;
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }
        .sidebar-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
        }
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-menu li {
            margin: 8px 0;
        }
        .sidebar-btn {
            width: 100%;
            text-align: left;
            padding: 14px 18px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
        }
        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            padding-left: 24px;
        }
        .sidebar-btn.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #06b6d4;
            padding-left: 20px;
        }
        .sidebar-btn span {
            font-size: 24px;
        }
        .sidebar-btn-action {
            width: 100%;
            text-align: left;
            padding: 14px 18px;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            margin-bottom: 8px;
        }
        .sidebar-btn-action:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateX(4px);
        }
        .sidebar-btn-action.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: #06b6d4;
            box-shadow: 0 0 12px rgba(6, 182, 212, 0.4);
        }
        .sidebar-btn-action span {
            font-size: 20px;
        }
        /* MAIN CONTENT WRAPPER */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .container {
            display: flex !important;
            flex-direction: column;
            max-width: none;
            margin: 0;
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            border: none;
            height: 100%;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 28px 40px;
            text-align: left;
            position: relative;
            overflow: hidden;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            transform: translate(100px, -100px);
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        .header h1 {
            font-size: 32px;
            margin: 0;
            font-weight: 800;
        }
        .header p {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 6px;
            margin-bottom: 0;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .current-user {
            font-size: 14px;
            opacity: 0.85;
        }
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 16px;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            max-height: 200px;
            overflow-x: auto;
            flex-shrink: 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #F3F0FF 0%, #E0F2FE 100%);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.12);
        }
        .stat-number {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
            color: var(--primary);
        }
        .stat-label {
            font-size: 12px;
            color: #6B7280;
            text-transform: uppercase;
            font-weight: 600;
        }
        .nav-tabs {
            display: none;
        }
        /* CONTENT AREA */
        .content {
            padding: 30px 40px;
            overflow-y: auto;
            flex: 1;
            background: #f5f7fa;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 28px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .form-card.in {
            border-left: 6px solid var(--success);
        }
        .form-card.out {
            border-left: 6px solid var(--danger);
        }
        .form-card h2 {
            font-size: 22px;
            margin-bottom: 16px;
            color: var(--primary);
            font-weight: 700;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin-bottom: 18px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            display: block;
            font-size: 15px;
            margin-bottom: 8px;
            color: #4B5563;
            font-weight: 600;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1.2px solid #D1D5DB;
            font-size: 15px;
            background: #FFFFFF;
            transition: all 0.2s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }
        .btn {
            border-radius: 8px;
            padding: 10px 18px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: #4f46e5;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover {
            background: #0d9488;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        .btn-warning:hover {
            background: #ea580c;
        }
        .btn-secondary {
            background: #6B7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4B5563;
        }
        .btn-icon {
            padding: 6px 8px;
            min-width: 34px;
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border-radius: 8px;
        }
        .mini-printer-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
        }
        .mini-printer-table td {
            padding: 3px 6px;
            border: none;
            vertical-align: middle;
        }
        .mini-printer-model { font-weight:600; }
        .printer-preview-block {
            max-width: 280px;
            white-space: normal;
            overflow: auto;
            word-break: break-word;
            padding: 4px 2px;
        }
        .alert {
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 16px;
            margin-top: 12px;
            border-left: 4px solid;
        }
        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border-left-color: var(--success);
        }
        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border-left-color: var(--danger);
        }
        .table-wrapper {
            margin-top: 20px;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
            overflow-x: auto;
            overflow-y hidden;
            background: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        table thead {
            background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
            position: sticky;
            top: 0;
        }
        table th, table td {
            padding: 10px 12px;
            border-bottom: 1px solid #E5E7EB;
            text-align: left;
            white-space: nowrap;
        }
        table th {
            font-weight: 700;
            color: #374151;
            font-size: 14px;
        }
        table tfoot td {
            background: #F9FAFB;
            font-weight: 700;
            font-size: 16px;
        }
        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin: 32px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-box {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .search-input {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1.5px solid #D1D5DB;
            font-size: 16px;
            flex: 1;
            min-width: 220px;
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 28px;
            border-radius: 18px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            max-height: 85vh;
            overflow-y: auto;
        }
        /* HISTORY TABLE STYLES */
        .history-table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
            background: white;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .history-table thead {
            background: linear-gradient(135deg, #0369a1 0%, #0c4a6e 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .history-table th {
            padding: 12px 12px;
            text-align: left;
            font-weight: 700;
            color: white;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            font-size: 14px;
        }
        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #E5E7EB;
            white-space: nowrap;
        }
        .history-table tbody tr:hover {
            background: #f0f9ff;
        }
        .history-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        .history-table tfoot {
            background: #fef3c7;
            font-weight: 700;
        }
        .history-table tfoot td {
            padding: 14px 12px;
            border-top: 2px solid #fcd34d;
            border-bottom: 2px solid #fcd34d;
        }
        .history-table .total-column {
            background: #fef08a;
            color: #92400e;
            font-weight: 800;
        }
        .modal-header {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            transition: color 0.2s ease;
        }
        .close-btn:hover {
            color: var(--danger);
        }
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .nav-tabs {
                padding: 0 10px;
            }
            .header h1 {
                font-size: 28px;
            }
            table {
                font-size: 12px;
            }
            table td, table th {
                padding: 8px 6px;
            }
        }
        .btn-edit {
            background: #F97316;
            color: white;
            padding: 8px 12px !important;
            font-size: 14px !important;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 6px;
            transition: background 0.2s ease;
        }
        .btn-edit:hover {
            background: #EA580C;
        }
        .btn-delete {
            background: #EF4444;
            color: white;
            padding: 8px 12px !important;
            font-size: 14px !important;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .btn-delete:hover {
            background: #DC2626;
        }
        .auth-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .auth-card {
            background: white;
            padding: 28px;
            border-radius: 18px;
            max-width: 460px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 1px solid #E5E7EB;
        }
        .auth-card h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 26px;
        }
        .auth-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 18px;
        }
        .auth-tabs button {
            flex: 1;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid #E5E7EB;
            background: #F9FAFB;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        .auth-tabs button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .auth-tab {
            display: none;
        }
        .auth-tab.active {
            display: block;
        }
        #authAlert .alert {
            margin-bottom: 0;
        }
        .bold-text {
            font-weight: 700;
        }
        .hidden-content {
            display: none;
        }
        .hidden-content.show {
            display: block;
        }
        .material-summary-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 12px 0;
            margin-bottom: 12px;
        }
        .material-summary-scroll::-webkit-scrollbar {
            height: 6px;
        }
        .material-summary-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .material-summary-scroll::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        .material-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 12px;
            min-width: 200px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            flex-shrink: 0;
        }
        .material-card-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 12px;
            word-break: break-word;
        }
        .material-card-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            font-size: 12px;
        }
        .material-card-item {
            text-align: center;
            padding: 6px;
            border-radius: 6px;
        }
        .material-card-in {
            background: #DBEAFE;
            color: #1E40AF;
            font-weight: 600;
        }
        .material-card-out {
            background: #FECACA;
            color: #991B1B;
            font-weight: 600;
        }
        .material-card-balance {
            background: #DCFCE7;
            color: #15803D;
            font-weight: 700;
        }
        .material-card-label {
            font-size: 10px;
            color: #6B7280;
            margin-top: 2px;
        }
        .total-column {
            background: #FFF9E6;
            font-weight: 700;
            color: #92400E;
        }
        .notes-column {
            background: #F0F9FF;
            font-weight: 600;
            color: #0369A1;
            min-width: 150px;
        }

        /* Counter Styles */
        .counter-container {
            font-family: Arial, sans-serif;
            background: #f5f7fb;
            margin: 0;
            padding: 0;
            font-size: 15px;
            color: #222;
        }
        .counter-container .container {
            max-width: 100%;
            margin: 16px 24px;
            background: #ffffff;
            padding: 20px 22px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
            border-radius: 10px;
            border: 1px solid #e5e7f0;
        }
        .counter-container h1 {
            margin-top: 0;
            font-size: 24px;
            color: #222b45;
        }
        .counter-container h2 {
            font-size: 19px;
            margin-bottom: 10px;
            color: #334155;
        }
        .counter-container .form-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 14px 18px;
            margin-top: 18px;
            background: #f9fafb;
        }
        .counter-container .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            margin-bottom: 12px;
        }
        .counter-container .form-group {
            flex: 1 1 180px;
            min-width: 180px;
            display: flex;
            flex-direction: column;
        }
        .counter-container label {
            font-size: 15px;
            margin-bottom: 6px;
            color: #4b5563;
        }
        .counter-container input, .counter-container select, .counter-container button {
            padding: 9px 10px;
            font-size: 15px;
        }
        .counter-container input, .counter-container select {
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: #ffffff;
        }
        .counter-container input:focus, .counter-container select:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96,165,250,0.25);
        }
        .counter-container button {
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background 0.15s ease, transform 0.05s ease;
        }
        .counter-container button:active {
            transform: scale(0.98);
        }
        .counter-container .btn-primary {
            background: #4f46e5;
            color: white;
        }
        .counter-container .btn-primary:hover {
            background: #4338ca;
        }
        .counter-container .btn-success {
            background: #22c55e;
            color: white;
        }
        .counter-container .btn-success:hover {
            background: #16a34a;
        }
        .counter-container .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }
        .counter-container .btn-secondary:hover {
            background: #d4d4d8;
        }
        .counter-container .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .counter-container .alert {
            margin-top: 10px;
            padding: 7px 9px;
            font-size: 14px;
            border-radius: 6px;
        }
        .counter-container .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .counter-container .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .counter-container .table-wrapper {
            margin-top: 12px;
            overflow-x: auto;
        }
        .counter-container table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .counter-container th, .counter-container td {
            border: 1px solid #e5e7eb;
            padding: 7px 9px;
            text-align: right;
        }
        .counter-container th:nth-child(1),
        .counter-container td:nth-child(1),
        .counter-container th:nth-child(2),
        .counter-container td:nth-child(2),
        .counter-container th:nth-child(3),
        .counter-container td:nth-child(3),
        .counter-container th:nth-child(4),
        .counter-container td:nth-child(4) {
            text-align: left;
        }
        .counter-container thead {
            background: #e5edff;
        }
        .counter-container tfoot td {
            font-weight: bold;
            background: #eef2ff;
        }
        .counter-container .total-column {
            background: #fef9c3;
        }
        .counter-container .section-line {
            margin-top: 24px;
            border-top: 2px dashed #e5e7eb;
            padding-top: 12px;
        }
        .counter-container .small-note {
            font-size: 13px;
            margin-top: 0;
            color: #6b7280;
        }

        /* Delivery Note Styles */
        .delivery-note-container {
            font-family: Arial, sans-serif;
            background: #f5f7fb;
            margin: 0;
            padding: 0;
            font-size: 15px;
            color: #222;
        }
        .delivery-note-container .container {
            max-width: 100%;
            margin: 16px 24px;
            background: #ffffff;
            padding: 20px 22px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
            border-radius: 10px;
            border: 1px solid #e5e7f0;
        }
        .delivery-note-container h1 {
            margin-top: 0;
            font-size: 24px;
            color: #222b45;
        }
        .delivery-note-container h2 {
            font-size: 19px;
            margin-bottom: 10px;
            color: #334155;
        }
        .delivery-note-container .form-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 14px 18px;
            margin-top: 18px;
            background: #f9fafb;
        }
        .delivery-note-container .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            margin-bottom: 12px;
        }
        .delivery-note-container .form-group {
            flex: 1 1 180px;
            min-width: 180px;
            display: flex;
            flex-direction: column;
        }
        .delivery-note-container label {
            font-size: 15px;
            margin-bottom: 6px;
            color: #4b5563;
        }
        .delivery-note-container input, .delivery-note-container select, .delivery-note-container button {
            padding: 9px 10px;
            font-size: 15px;
        }
        .delivery-note-container input, .delivery-note-container select {
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: #ffffff;
        }
        .delivery-note-container input:focus, .delivery-note-container select:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96,165,250,0.25);
        }
        .delivery-note-container button {
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background 0.15s ease, transform 0.05s ease;
        }
        .delivery-note-container button:active {
            transform: scale(0.98);
        }
        .delivery-note-container .btn-primary {
            background: #4f46e5;
            color: white;
        }
        .delivery-note-container .btn-primary:hover {
            background: #4338ca;
        }
        .delivery-note-container .btn-success {
            background: #22c55e;
            color: white;
        }
        .delivery-note-container .btn-success:hover {
            background: #16a34a;
        }
        .delivery-note-container .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }
        .delivery-note-container .btn-secondary:hover {
            background: #d4d4d8;
        }
        .delivery-note-container .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .delivery-note-container .alert {
            margin-top: 10px;
            padding: 7px 9px;
            font-size: 14px;
            border-radius: 6px;
        }
        .delivery-note-container .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .delivery-note-container .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .delivery-note-container .table-wrapper {
            margin-top: 12px;
            overflow-x: auto;
        }
        .delivery-note-container table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .delivery-note-container th, .delivery-note-container td {
            border: 1px solid #e5e7eb;
            padding: 7px 9px;
            text-align: right;
        }
        .delivery-note-container th:nth-child(1),
        .delivery-note-container td:nth-child(1),
        .delivery-note-container th:nth-child(2),
        .delivery-note-container td:nth-child(2),
        .delivery-note-container th:nth-child(3),
        .delivery-note-container td:nth-child(3),
        .delivery-note-container th:nth-child(4),
        .delivery-note-container td:nth-child(4) {
            text-align: left;
        }
        .delivery-note-container thead {
            background: #e5edff;
        }
        .delivery-note-container tfoot td {
            font-weight: bold;
            background: #eef2ff;
        }
        .delivery-note-container .total-column {
            background: #fef9c3;
        }
        .delivery-note-container .section-line {
            margin-top: 24px;
            border-top: 2px dashed #e5e7eb;
            padding-top: 12px;
        }
        .delivery-note-container .small-note {
            font-size: 13px;
            margin-top: 0;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- LOGIN SIGNUP UI -->
    <div class="auth-wrapper" id="authWrapper">
        <div class="auth-card">
            <h2>MS Stocks Login</h2>
            <div class="auth-tabs">
                <button id="tabLogin" class="active" onclick="showAuthTab('login')">Login</button>
                <button id="tabRegister" onclick="showAuthTab('register')">Create Account</button>
                <button id="tabForgot" onclick="showAuthTab('forgot')">Forgot Password</button>
            </div>

            <!-- LOGIN -->
            <div id="authLogin" class="auth-tab active">
                <div class="form-group">
                    <label>User ID / Phone</label>
                    <input type="text" id="loginUser" placeholder="User ID ya Phone no.">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Password">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="handleLogin()">Login</button>
            </div>

            <!-- REGISTER -->
            <div id="authRegister" class="auth-tab">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" placeholder="Employee Name">
                </div>
                <div class="form-group">
                    <label>Employee Code</label>
                    <input type="text" id="regEmpCode" placeholder="Emp Code">
                </div>
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="regUserId" placeholder="Login ID (unique)">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="regPhone" placeholder="10 digit mobile" style="flex:1;">
                        <button class="btn btn-warning" type="button" onclick="requestOtp('register')">Get OTP</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>OTP</label>
                    <input type="text" id="regOtp" placeholder="Enter OTP">
                    <small id="otpInfoRegister" style="font-size: 11px; color: #6B7280;"></small>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Password">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="regPassword2" placeholder="Re-enter Password">
                </div>
                <button class="btn btn-success" style="width: 100%; margin-top: 10px;" onclick="handleRegister()">Create Account</button>
            </div>

            <!-- FORGOT PASSWORD -->
            <div id="authForgot" class="auth-tab">
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="fpUserId" placeholder="Registered User ID">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="fpPhone" placeholder="Registered Phone" style="flex:1;">
                        <button class="btn btn-warning" type="button" onclick="requestOtp('forgot')">Get OTP</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>OTP</label>
                    <input type="text" id="fpOtp" placeholder="Enter OTP">
                    <small id="otpInfoForgot" style="font-size: 11px; color: #6B7280;"></small>
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="fpNewPassword" placeholder="New Password">
                </div>
                <button class="btn btn-success" style="width: 100%; margin-top: 10px;" onclick="handleResetPassword()">Reset Password</button>
            </div>

            <div id="authAlert" style="margin-top: 12px;"></div>
        </div>
    </div>

    <!-- PRINTERS VIEW MODAL -->
    <div id="printersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üìá Printers</span>
                <button class="close-btn" onclick="closePrintersModal()">‚úï</button>
            </div>
            <div id="printersModalBody" style="font-size:14px;"></div>
            <div class="btn-group" style="margin-top:12px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closePrintersModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP AFTER LOGIN -->
    <div id="mainApp" style="display: none;">
        <!-- LEFT SIDEBAR NAVIGATION -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">MS Stocks</div>
                <div class="sidebar-subtitle">Inventory Manager</div>
            </div>
            <ul class="sidebar-menu">
    <!-- Dashboard -->
    <li>
        <button class="sidebar-btn active" onclick="switchTab('dashboard')">
            <span>üìä</span> Dashboard
        </button>
    </li>

    <!-- Add Stock / Dispatch OUT ‚Äì Dashboard ke turant nichhe -->
    <li>
        <button class="sidebar-btn-action" onclick="switchTab('incoming-form')">
            <span>‚ûï</span> Add Stock (IN)
        </button>
    </li>
    <li>
        <button class="sidebar-btn-action" onclick="switchTab('outgoing-form')">
            <span>‚ûñ</span> Dispatch (OUT)
        </button>
    </li>

    <!-- Baaki tabs neeche -->
    <li>
        <button class="sidebar-btn" onclick="switchTab('delivery-note')">
            <span>üßæ</span> Delivery
        </button>
    </li>
    <li>
        <button class="sidebar-btn" onclick="switchTab('printer-parts')">
            <span>üñ®Ô∏è</span> Printer Parts
        </button>
    </li>
    <li>
        <button class="sidebar-btn" onclick="switchTab('hospital-master')">
            <span>üè•</span> Hospital List
        </button>
    </li>
    <li>
        <button class="sidebar-btn" onclick="switchTab('archive-summary')">
            <span>üì¶</span> Archive
        </button>
    </li>
    <li>
        <button class="sidebar-btn" onclick="switchTab('monthly-counter')">
            <span>üìä</span> Counter
        </button>
    </li>
</ul>
        </aside>

        <!-- MAIN CONTENT WRAPPER -->
        <div class="main-wrapper">
            <!-- HEADER -->
            <div class="header">
                <div class="header-top">
                    <div>
                        <h1>MS Stocks Service'S</h1>
                        <p>Inventory Tracking & Paper/Ink Stock Management</p>
                    </div>
                    <div class="header-right">
                        <span class="current-user" id="currentUserInfo">-</span>
                        <button class="btn btn-secondary" onclick="handleLogout()" style="padding: 10px 18px; font-size: 14px;">Logout</button>
                    </div>
                </div>
            </div>

            <!-- STATS BAR -->
            <div class="stats-bar" id="consumableStats"></div>

            <!-- CONTENT AREA -->
            <div class="content">
                <div class="container">
            <!-- TAB 0: DASHBOARD -->
            <div id="dashboard" class="tab-content active">
                <h2 style="color: var(--primary); font-size: 28px; margin-bottom: 20px;">üìä Dashboard - Current Stock Status</h2>
                <p style="font-size: 18px; color: #6B7280; margin-bottom: 24px;">
                    View all real-time stock calculations and material summaries below.
                </p>
                
                <!-- MATERIAL-WISE SUMMARY TABLE -->
                <div style="background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
                    <h3 style="color: var(--primary); font-size: 22px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <span>üìã</span> Material-Wise Summary (All Items)
                    </h3>
                    <p style="font-size: 14px; color: #6B7280; margin-bottom: 16px;">
                        Real-time calculation: IN = Total Incoming Stock | OUT = Total Dispatched to Hospitals | BAL = Balance (IN ‚Äì OUT)
                    </p>
                    
                    <div style="overflow-x: auto; border-radius: 10px; border: 1px solid var(--border-color);">
                        <table style="width: 100%; border-collapse: collapse; font-size: 15px;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, var(--sidebar-top) 0%, var(--sidebar-bottom) 100%); color: white; position: sticky; top: 0;">
                                    <th style="padding: 14px 16px; text-align: left; font-weight: 700; border-bottom: 2px solid #E5E7EB;">Material Name</th>
                                    <th style="padding: 14px 16px; text-align: center; font-weight: 700; border-bottom: 2px solid #E5E7EB; white-space: nowrap;">üì• Total IN</th>
                                    <th style="padding: 14px 16px; text-align: center; font-weight: 700; border-bottom: 2px solid #E5E7EB; white-space: nowrap;">üì§ Total OUT</th>
                                    <th style="padding: 14px 16px; text-align: center; font-weight: 700; border-bottom: 2px solid #E5E7EB; white-space: nowrap;">‚öñÔ∏è Balance</th>
                                    <th style="padding: 14px 16px; text-align: center; font-weight: 700; border-bottom: 2px solid #E5E7EB; white-space: nowrap;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="materialSummaryTableBody">
                                <tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">Loading material data...</td></tr>
                            </tbody>
                            <tfoot style="background: #fef3c7;">
                                <tr style="font-weight: 700; font-size: 16px;">
                                    <td style="padding: 14px 16px; border-top: 2px solid #E5E7EB;">GRAND TOTAL</td>
                                    <td style="padding: 14px 16px; text-align: center; border-top: 2px solid #E5E7EB;" id="materialSummaryTotalIn">0</td>
                                    <td style="padding: 14px 16px; text-align: center; border-top: 2px solid #E5E7EB;" id="materialSummaryTotalOut">0</td>
                                    <td style="padding: 14px 16px; text-align: center; border-top: 2px solid #E5E7EB; background: #fef08a;" id="materialSummaryTotalBalance">0</td>
                                    <td style="padding: 14px 16px; text-align: center; border-top: 2px solid #E5E7EB;"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 1a: INCOMING FORM ONLY -->
            <div id="incoming-form" class="tab-content">
                <!-- ADD STOCK IN -->
                <div class="form-card in">
                    <h2>‚ûï Add Paper/Ink Stock (INCOMING)</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Stock Arrival</label>
                            <input type="date" id="creditDate">
                        </div>
                        <div class="form-group">
                            <label>Select Month</label>
                            <select id="creditMonth"></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>A4-210 GSM</label><input type="number" id="creditA4210" placeholder="0"></div>
                        <div class="form-group"><label>A3-210 GSM</label><input type="number" id="creditA3210" placeholder="0"></div>
                        <div class="form-group"><label>13x17 Film</label><input type="number" id="credit13x17Film" placeholder="0"></div>
                        <div class="form-group"><label>A4-180 GSM</label><input type="number" id="creditA4180" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>8x10 Film</label><input type="number" id="creditFilm" placeholder="0"></div>
                        <div class="form-group"><label>8x10 Macron Weight</label><input type="number" id="creditFilm8x10Macron" placeholder="0"></div>
                        <div class="form-group"><label>A3 Macrone Weight</label><input type="number" id="creditFilmA3Macrone" placeholder="0"></div>
                        <div class="form-group"><label>A4 Macrom Weight</label><input type="number" id="creditFilmA4Macrom" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>A4 130GSM</label><input type="number" id="creditA4130GSM" placeholder="0"></div>
                        <div class="form-group"><label>A4 Film 210GSM</label><input type="number" id="creditA4Film210GSM" placeholder="0"></div>
                        <div class="form-group"><label>Black Ink</label><input type="number" id="creditBlack" placeholder="0"></div>
                        <div class="form-group"><label>Yellow Ink</label><input type="number" id="creditYellow" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Cyan Ink</label><input type="number" id="creditCyan" placeholder="0"></div>
                        <div class="form-group"><label>Magenta Ink</label><input type="number" id="creditMegenta" placeholder="0"></div>
                        <div class="form-group"><label>500ML Black</label><input type="number" id="creditBlack500ML" placeholder="0"></div>
                        <div class="form-group"><label>Gary Ink</label><input type="number" id="creditGaryInk" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Canon Cyan</label><input type="number" id="creditCanonCyan" placeholder="0"></div>
                        <div class="form-group"><label>Canon Magenta</label><input type="number" id="creditCanonMagenta" placeholder="0"></div>
                        <div class="form-group"><label>Canon Yellow</label><input type="number" id="creditCanonYellow" placeholder="0"></div>
                        <div class="form-group"><label>Canon Gray</label><input type="number" id="creditCanonGray" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Notes/Remarks</label><input type="text" id="creditRemark" placeholder="Optional notes"></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="addCreditEntry()">‚úÖ Add to Stock</button>
                        <button class="btn btn-secondary" onclick="clearCreditForm()">üîÑ Clear Form</button>
                    </div>
                    <div id="creditAlert" style="margin-top: 10px;"></div>
                </div>

                <!-- STOCK IN HISTORY - INLINE IN INCOMING FORM TAB -->
                <div style="margin-top: 40px;">
                    <div class="section-title">
                        <span>üìú Stock IN History</span>
                        <button class="btn btn-secondary" id="btnIncomingHistory" onclick="toggleSection('incomingHistorySection','btnIncomingHistory','History')">Show History</button>
                    </div>
                    <div id="incomingHistorySection" style="display: none;">
                        <div class="search-box">
                            <input type="text" class="search-input" id="incomingHistorySearch" placeholder="Search by date, material, or remarks..." onkeyup="filterIncomingHistory()">
                            <button class="btn btn-secondary" onclick="filterIncomingHistoryAdvanced()">üîç Search</button>
                            <button class="btn btn-secondary" onclick="exportStockInToExcel()">üì• Export Excel</button>
                        </div>
                        <div class="table-wrapper history-table-wrapper">
                            <table class="history-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="min-width: 100px;">üìÖ Date</th>
                                        <th style="min-width: 100px;">üìÜ Month</th>
                                        <th style="min-width: 100px;">A4-210 GSM</th>
                                        <th style="min-width: 100px;">A3-210 GSM</th>
                                        <th style="min-width: 100px;">13x17 Film</th>
                                        <th style="min-width: 100px;">A4-180 GSM</th>
                                        <th style="min-width: 100px;">8x10 Film</th>
                                        <th style="min-width: 120px;">8x10 Macron</th>
                                        <th style="min-width: 120px;">A3 Macrone</th>
                                        <th style="min-width: 100px;">A4 Macrom</th>
                                        <th style="min-width: 100px;">A4 130GSM</th>
                                        <th style="min-width: 130px;">A4 Film 210GSM</th>
                                        <th style="min-width: 100px;">Black Ink</th>
                                        <th style="min-width: 100px;">Yellow Ink</th>
                                        <th style="min-width: 100px;">Cyan Ink</th>
                                        <th style="min-width: 100px;">Magenta Ink</th>
                                        <th style="min-width: 100px;">500ML Black</th>
                                        <th style="min-width: 100px;">Gary Ink</th>
                                        <th style="min-width: 100px;">Canon Cyan</th>
                                        <th style="min-width: 120px;">Canon Magenta</th>
                                        <th style="min-width: 100px;">Canon Yellow</th>
                                        <th style="min-width: 100px;">Canon Gray</th>
                                        <th style="min-width: 100px;">üìä Total</th>
                                        <th style="min-width: 150px;">üìù Notes</th>
                                        <th style="min-width: 100px;">‚öôÔ∏è Action</th>
                                    </tr>
                                </thead>
                                <tbody id="incomingHistoryBody">
                                    <tr><td colspan="25" style="text-align: center; padding: 20px; color: #999;">No stock IN records yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div><!-- end incoming-form tab -->

            <!-- TAB 1b: PAPER & INK - HISTORY VIEW -->
            <div id="credit-dispatch" class="tab-content">
                <!-- STOCK IN HISTORY -->
                <div style="margin-top: 0px;">
                    <div class="section-title">
                        <span>üìú Stock IN History - View / Edit</span>
                        <button class="btn btn-secondary" id="btnCreditHistory" onclick="toggleSection('creditHistorySection','btnCreditHistory','History')">Show History</button>
                    </div>
                    <div id="creditHistorySection" style="display: none;">
                        <div class="search-box">
                            <input type="text" class="search-input" id="stockSearchInput" placeholder="Search by date or notes..." onkeyup="filterStockTable()">
                            <button class="btn btn-secondary" onclick="filterStockTableAdvanced()">üîç Search</button>
                            <button class="btn btn-secondary" onclick="exportToExcel()">üì• Export CSV</button>
                        </div>
                        <div class="table-wrapper history-table-wrapper">
                            <table id="creditTable" class="history-table">
                                <thead>
                                    <tr>
                                        <th>üìÖ Date</th><th>üìÜ Month</th><th>A4-210 GSM</th><th>A3-210 GSM</th><th>13x17 Film</th><th>A4-180 GSM</th><th>8x10 Film</th><th>8x10 Macron</th><th>A3 Macrone</th><th>A4 Macrom</th><th>A4 130GSM</th><th>A4 Film 210GSM</th><th>Black Ink</th><th>Yellow Ink</th><th>Cyan Ink</th><th>Magenta Ink</th><th>500ML Black</th><th>Gary Ink</th><th>Canon Cyan</th><th>Canon Magenta</th><th>Canon Yellow</th><th>Canon Gray</th><th>üìä Total</th><th>üìù Notes</th><th>‚öôÔ∏è Action</th>
                                    </tr>
                                </thead>
                                <tbody id="creditTableBody"></tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2"><strong>TOTAL RECEIVED</strong></td>
                                        <td id="totalCreditA4210">0</td><td id="totalCreditA3210">0</td><td id="totalCredit13x17Film">0</td><td id="totalCreditA4180">0</td><td id="totalCreditFilm">0</td><td id="totalCreditFilm8x10Macron">0</td><td id="totalCreditFilmA3Macrone">0</td><td id="totalCreditFilmA4Macrom">0</td><td id="totalCreditA4130GSM">0</td><td id="totalCreditA4Film210GSM">0</td><td id="totalCreditBlack">0</td><td id="totalCreditYellow">0</td><td id="totalCreditCyan">0</td><td id="totalCreditMagenta">0</td><td id="totalCredit500ML">0</td><td id="totalCreditGaryInk">0</td><td id="totalCreditCanonCyan">0</td><td id="totalCreditCanonMagenta">0</td><td id="totalCreditCanonYellow">0</td><td id="totalCreditCanonGray">0</td><td id="grandTotalCredit" class="total-column"><strong>0</strong></td><td></td><td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- DISPATCH CARD -->
                <div class="form-card out" style="margin-top: 40px;">
                    <h2>‚ûñ Hospital Dispatch (OUTGOING)</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Dispatch Date</label>
                            <input type="date" id="dispatchDate">
                        </div>
                        <div class="form-group">
                            <label>Select Hospital</label>
                            <select id="dispatchHospital" onchange="updateDispatchHospitalInfo()">
                                <option value="">-- Choose Hospital --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location (Auto-filled)</label>
                            <input type="text" id="dispatchLocation" readonly placeholder="Auto-filled from Hospital">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>A4-210</label><input type="number" id="dispatchA4210" placeholder="0"></div>
                        <div class="form-group"><label>A3-210</label><input type="number" id="dispatchA3210" placeholder="0"></div>
                        <div class="form-group"><label>13x17 Film</label><input type="number" id="dispatch13x17Film" placeholder="0"></div>
                        <div class="form-group"><label>A4-180</label><input type="number" id="dispatchA4180" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>8x10 Film</label><input type="number" id="dispatchFilm" placeholder="0"></div>
                        <div class="form-group"><label>8x10 Macron</label><input type="number" id="dispatchFilm8x10Macron" placeholder="0"></div>
                        <div class="form-group"><label>A3 Macrone</label><input type="number" id="dispatchFilmA3Macrone" placeholder="0"></div>
                        <div class="form-group"><label>A4 Macrom</label><input type="number" id="dispatchFilmA4Macrom" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>A4 130GSM</label><input type="number" id="dispatchA4130GSM" placeholder="0"></div>
                        <div class="form-group"><label>A4 Film 210GSM</label><input type="number" id="dispatchA4Film210GSM" placeholder="0"></div>
                        <div class="form-group"><label>Black</label><input type="number" id="dispatchBlack" placeholder="0"></div>
                        <div class="form-group"><label>Yellow</label><input type="number" id="dispatchYellow" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Cyan</label><input type="number" id="dispatchCyan" placeholder="0"></div>
                        <div class="form-group"><label>Magenta</label><input type="number" id="dispatchMegenta" placeholder="0"></div>
                        <div class="form-group"><label>500ML Black</label><input type="number" id="dispatchBlack500ML" placeholder="0"></div>
                        <div class="form-group"><label>Gary Ink</label><input type="number" id="dispatchGaryInk" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Canon Cyan</label><input type="number" id="dispatchCanonCyan" placeholder="0"></div>
                        <div class="form-group"><label>Canon Magenta</label><input type="number" id="dispatchCanonMagenta" placeholder="0"></div>
                        <div class="form-group"><label>Canon Yellow</label><input type="number" id="dispatchCanonYellow" placeholder="0"></div>
                        <div class="form-group"><label>Canon Gray</label><input type="number" id="dispatchCanonGray" placeholder="0"></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-danger" onclick="addDispatchEntry()">‚úÖ Record Dispatch</button>
                        <button class="btn btn-secondary" onclick="clearDispatchForm()">üîÑ Clear Form</button>
                    </div>
                    <div id="dispatchAlert" style="margin-top: 10px;"></div>
                </div>
            </div><!-- end credit-dispatch tab -->

            <!-- TAB 1c: OUTGOING FORM ONLY -->
            <div id="outgoing-form" class="tab-content">
                <!-- DISPATCH CARD -->
                <div class="form-card out" style="margin-top: 0px;">
                    <h2>‚ûñ Hospital Dispatch (OUTGOING)</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Dispatch Date</label>
                            <input type="date" id="dispatchDate">
                        </div>
                        <div class="form-group">
                            <label>Select Hospital</label>
                            <select id="dispatchHospital" onchange="updateDispatchHospitalInfo()">
                                <option value="">-- Choose Hospital --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location (Auto-filled)</label>
                            <input type="text" id="dispatchLocation" readonly placeholder="Auto-filled from Hospital">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>A4-210</label><input type="number" id="dispatchA4210" placeholder="0"></div>
                        <div class="form-group"><label>A3-210</label><input type="number" id="dispatchA3210" placeholder="0"></div>
                        <div class="form-group"><label>13x17 Film</label><input type="number" id="dispatch13x17Film" placeholder="0"></div>
                        <div class="form-group"><label>A4-180</label><input type="number" id="dispatchA4180" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>8x10 Film</label><input type="number" id="dispatchFilm" placeholder="0"></div>
                        <div class="form-group"><label>8x10 Macron</label><input type="number" id="dispatchFilm8x10Macron" placeholder="0"></div>
                        <div class="form-group"><label>A3 Macrone</label><input type="number" id="dispatchFilmA3Macrone" placeholder="0"></div>
                        <div class="form-group"><label>A4 Macrom</label><input type="number" id="dispatchFilmA4Macrom" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>A4 130GSM</label><input type="number" id="dispatchA4130GSM" placeholder="0"></div>
                        <div class="form-group"><label>A4 Film 210GSM</label><input type="number" id="dispatchA4Film210GSM" placeholder="0"></div>
                        <div class="form-group"><label>Black</label><input type="number" id="dispatchBlack" placeholder="0"></div>
                        <div class="form-group"><label>Yellow</label><input type="number" id="dispatchYellow" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Cyan</label><input type="number" id="dispatchCyan" placeholder="0"></div>
                        <div class="form-group"><label>Magenta</label><input type="number" id="dispatchMegenta" placeholder="0"></div>
                        <div class="form-group"><label>500ML Black</label><input type="number" id="dispatchBlack500ML" placeholder="0"></div>
                        <div class="form-group"><label>Gary Ink</label><input type="number" id="dispatchGaryInk" placeholder="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Canon Cyan</label><input type="number" id="dispatchCanonCyan" placeholder="0"></div>
                        <div class="form-group"><label>Canon Magenta</label><input type="number" id="dispatchCanonMagenta" placeholder="0"></div>
                        <div class="form-group"><label>Canon Yellow</label><input type="number" id="dispatchCanonYellow" placeholder="0"></div>
                        <div class="form-group"><label>Canon Gray</label><input type="number" id="dispatchCanonGray" placeholder="0"></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-danger" onclick="addDispatchEntry()">‚úÖ Record Dispatch</button>
                        <button class="btn btn-secondary" onclick="clearDispatchForm()">üîÑ Clear Form</button>
                    </div>
                    <div id="dispatchAlert" style="margin-top: 10px;"></div>
                </div>

                <!-- DISPATCH OUT HISTORY - INLINE IN OUTGOING FORM TAB -->
                <div style="margin-top: 40px;">
                    <div class="section-title">
                        <span>üìú Dispatch OUT History</span>
                        <button class="btn btn-secondary" id="btnOutgoingHistory" onclick="toggleSection('outgoingHistorySection','btnOutgoingHistory','History')">Show History</button>
                    </div>
                    <div id="outgoingHistorySection" style="display: none;">
                        <div class="search-box">
                            <input type="text" class="search-input" id="outgoingHistorySearch" placeholder="Search by date, hospital, or material..." onkeyup="filterOutgoingHistory()">
                            <button class="btn btn-secondary" onclick="filterOutgoingHistoryAdvanced()">üîç Search</button>
                            <button class="btn btn-secondary" onclick="exportDispatchOutToExcel()">üì• Export Excel</button>
                        </div>
                        <div class="table-wrapper history-table-wrapper">
                            <table class="history-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="min-width: 100px;">üìÖ Date</th>
                                        <th style="min-width: 100px;">üè• Hospital</th>
                                        <th style="min-width: 100px;">A4-210 GSM</th>
                                        <th style="min-width: 100px;">A3-210 GSM</th>
                                        <th style="min-width: 100px;">13x17 Film</th>
                                        <th style="min-width: 100px;">A4-180 GSM</th>
                                        <th style="min-width: 100px;">8x10 Film</th>
                                        <th style="min-width: 120px;">8x10 Macron</th>
                                        <th style="min-width: 120px;">A3 Macrone</th>
                                        <th style="min-width: 100px;">A4 Macrom</th>
                                        <th style="min-width: 100px;">A4 130GSM</th>
                                        <th style="min-width: 130px;">A4 Film 210GSM</th>
                                        <th style="min-width: 100px;">Black Ink</th>
                                        <th style="min-width: 100px;">Yellow Ink</th>
                                        <th style="min-width: 100px;">Cyan Ink</th>
                                        <th style="min-width: 100px;">Magenta Ink</th>
                                        <th style="min-width: 100px;">500ML Black</th>
                                        <th style="min-width: 100px;">Gary Ink</th>
                                        <th style="min-width: 100px;">Canon Cyan</th>
                                        <th style="min-width: 120px;">Canon Magenta</th>
                                        <th style="min-width: 100px;">Canon Yellow</th>
                                        <th style="min-width: 100px;">Canon Gray</th>
                                        <th style="min-width: 100px;">üìä Total</th>
                                        <th style="min-width: 150px;">üìç Location</th>
                                        <th style="min-width: 100px;">‚öôÔ∏è Action</th>
                                    </tr>
                                </thead>
                                <tbody id="outgoingHistoryBody">
                                    <tr><td colspan="25" style="text-align: center; padding: 20px; color: #999;">No dispatch OUT records yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div><!-- end outgoing-form tab -->

            <!-- TAB 1d: DISPATCH HISTORY -->
            <div id="dispatch-history" class="tab-content">
                <!-- DISPATCH HISTORY -->
                <div style="margin-top: 0px;">
                    <div class="section-title">
                        <span>üìú Dispatch OUT History</span>
                        <button class="btn btn-secondary" id="btnDispatchHistory" onclick="toggleSection('dispatchHistorySection','btnDispatchHistory','History')">Show History</button>
                    </div>
                    <div id="dispatchHistorySection" style="display: none;">
                        <div class="search-box">
                            <input type="text" class="search-input" id="dispatchSearchInput" placeholder="Search by date or hospital..." onkeyup="filterDispatchTable()">
                            <button class="btn btn-secondary" onclick="filterDispatchTableAdvanced()">üîç Search</button>
                        </div>
                        <div class="table-wrapper history-table-wrapper">
                            <table id="dispatchTable" class="history-table">
                                <thead>
                                    <tr>
                                        <th>üìÖ Date</th><th>üè• Hospital</th><th>üìç Location</th><th>A4-210 GSM</th><th>A3-210 GSM</th><th>13x17 Film</th><th>A4-180 GSM</th><th>8x10 Film</th><th>8x10 Macron</th><th>A3 Macrone</th><th>A4 Macrom</th><th>A4 130GSM</th><th>A4 Film 210GSM</th><th>Black Ink</th><th>Yellow Ink</th><th>Cyan Ink</th><th>Magenta Ink</th><th>500ML Black</th><th>Gary Ink</th><th>Canon Cyan</th><th>Canon Magenta</th><th>Canon Yellow</th><th>Canon Gray</th><th>üìä Total</th><th>‚öôÔ∏è Action</th>
                                    </tr>
                                </thead>
                                <tbody id="dispatchTableBody"></tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3"><strong>TOTAL DISPATCHED</strong></td>
                                        <td id="totalDispatchA4210">0</td><td id="totalDispatchA3210">0</td><td id="totalDispatch13x17Film">0</td><td id="totalDispatchA4180">0</td><td id="totalDispatchFilm">0</td><td id="totalDispatchFilm8x10Macron">0</td><td id="totalDispatchFilmA3Macrone">0</td><td id="totalDispatchFilmA4Macrom">0</td><td id="totalDispatchA4130GSM">0</td><td id="totalDispatchA4Film210GSM">0</td><td id="totalDispatchBlack">0</td><td id="totalDispatchYellow">0</td><td id="totalDispatchCyan">0</td><td id="totalDispatchMagenta">0</td><td id="totalDispatchBlack500ML">0</td><td id="totalDispatchGaryInk">0</td><td id="totalDispatchCanonCyan">0</td><td id="totalDispatchCanonMagenta">0</td><td id="totalDispatchCanonYellow">0</td><td id="totalDispatchCanonGray">0</td><td id="grandTotalDispatch" class="total-column"><strong>0</strong></td><td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div><!-- end dispatch-history tab -->

            <!-- TAB 2 DELIVERY NOTE -->
            <div id="delivery-note" class="tab-content">
                <div class="delivery-note-container">
                    <div class="container">
                        <h1>üßæ Delivery Note Management</h1>
                        
                        <!-- DELIVERY NOTE HISTORY -->
                        <div class="form-card">
                            <h2>üìã Delivery Note History</h2>
                            <p class="small-note">
                                All delivery notes generated from Hospital Dispatch are listed here. 
                                Click Print to download the PDF again.
                            </p>
                            <div class="table-wrapper">
                                <table id="deliveryNoteTable">
                                    <thead>
                                        <tr>
                                            <th>Delivery Note No</th>
                                            <th>Date</th>
                                            <th>Hospital Name</th>
                                            <th>Location</th>
                                            <th>Printer Model</th>
                                            <th>Printer Serial</th>
                                            <th>Total Items</th>
                                            <th>Total Quantity</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="deliveryNoteTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3 PRINTER PARTS -->
            <div id="printer-parts" class="tab-content">
                <h2 class="section-title">üñ®Ô∏è Printer Parts Stock</h2>
                <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:15px; margin-bottom:20px;" id="partsStockCards"></div>
                
                <div style="display:flex; flex-wrap:wrap; gap:20px; align-items:flex-start;">
                    <div class="form-card in" style="flex:1; min-width:280px;">
                        <h3 style="color:var(--success); margin-bottom:10px;">‚ûï Add Parts Stock IN</h3>
                        <div class="form-row">
                            <div class="form-group"><label>Date</label><input type="date" id="partCreditDate"></div>
                            <div class="form-group">
                                <label>Part Name</label>
                                <select id="partCreditType">
                                    <option value="MB Box Chip">MB Box Chip</option>
                                    <option value="Pickup Roller">Pickup Roller</option>
                                    <option value="Bypass Assembly">Bypass Assembly</option>
                                    <option value="Canon MB Chip">Canon MB Chip</option>
                                    <option value="Timing Belt">Timing Belt</option>
                                    <option value="Ink Tank L15150/40">Ink Tank L15150/40</option>
                                    <option value="Ink Pad Epson L40/L50">Ink Pad Epson L40/L50</option>
                                    <option value="Canon Ink Pad">Canon Ink Pad</option>
                                    <option value="M11050 IN Pad">M11050 IN Pad</option>
                                    <option value="Other">Other (Custom)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Quantity</label><input type="number" id="partCreditQty" placeholder="Enter quantity" min="1"></div>
                            <div class="form-group" id="customPartNameGroup" style="display:none;">
                                <label>Custom Part Name</label>
                                <input type="text" id="partCreditCustomName" placeholder="Enter custom part name">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addPartCredit()">‚úÖ Add to Inventory</button>
                    </div>

                    <div class="form-card out" style="flex:1; min-width:280px;">
                        <h3 style="color:var(--danger); margin-bottom:10px;">‚ûñ Dispatch Part</h3>
                        <div class="form-row">
                            <div class="form-group"><label>Date</label><input type="date" id="partDispatchDate"></div>
                            <div class="form-group">
                                <label>Select Hospital</label>
                                <select id="partDispatchHospital" onchange="updatePartDispatchForm()">
                                    <option value="">-- Choose Hospital --</option>
                                </select>
                            </div>
                        </div>
                        <div style="background:white; padding:12px; margin-bottom:12px; border-radius:10px; font-size:12px; border:2px solid #FCD34D;">
                            <strong>Hospital Info (Auto-Filled)</strong>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:8px;">
                                <div><strong>Contact:</strong> <span id="pdContact-span">-</span></div>
                                <div><strong>Mobile:</strong> <span id="pdMobile-span">-</span></div>
                                <div><strong>Printer:</strong> <span id="pdPrinter-span">-</span></div>
                                <div><strong>Serial:</strong> <span id="pdSerial-span">-</span></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Select Part</label>
                                <select id="partDispatchType">
                                    <option value="MB Box Chip">MB Box Chip</option>
                                    <option value="Pickup Roller">Pickup Roller</option>
                                    <option value="Bypass Assembly">Bypass Assembly</option>
                                    <option value="Canon MB Chip">Canon MB Chip</option>
                                    <option value="Timing Belt">Timing Belt</option>
                                    <option value="Ink Tank L15150/40">Ink Tank L15150/40</option>
                                    <option value="Ink Pad Epson L40/L50">Ink Pad Epson L40/L50</option>
                                    <option value="Canon Ink Pad">Canon Ink Pad</option>
                                    <option value="M11050 IN Pad">M11050 IN Pad</option>
                                    <option value="Other">Other (Custom)</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Quantity</label><input type="number" id="partDispatchQty" placeholder="Enter quantity" min="1"></div>
                        </div>
                        <div class="form-group" id="customPartDispatchGroup" style="display:none;">
                            <label>Custom Part Name</label>
                            <input type="text" id="partDispatchCustomName" placeholder="Enter custom part name">
                        </div>
                        <button class="btn btn-danger" onclick="addPartDispatch()">‚úÖ Dispatch Part</button>
                    </div>
                </div>

                <div id="partsAlert" style="margin-top: 15px;"></div>

                <h3 class="section-title" style="margin-top: 24px;">üìú Parts Transaction History</h3>
                <div class="table-wrapper">
                    <table id="partsTable">
                        <thead>
                            <tr>
                                <th>Date</th><th>Type</th><th>Part Name</th><th>Qty</th><th>Hospital</th><th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="partsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 4 HOSPITAL LIST -->
            <div id="hospital-master" class="tab-content">
                <h2 class="section-title">üè• Hospital List</h2>
                <div class="form-card">
                    <div class="form-row">
                        <div class="form-group"><label>Hospital Name</label><input type="text" id="hospitalName"></div>
                        <div class="form-group"><label>Location / City</label><input type="text" id="hospitalLocation"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Contact Person</label><input type="text" id="hospitalContact"></div>
                        <div class="form-group"><label>Mobile Number</label><input type="text" id="hospitalMobile"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Printer Name</label><input type="text" id="hospitalPrinterName"></div>
                        <div class="form-group"><label>Printer Serial</label><input type="text" id="hospitalPrinterSerial"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Installation Date</label><input type="date" id="hospitalInstallDate"></div>
                        <div class="form-group"><label>Pincode</label><input type="text" id="hospitalPincode"></div>
                    </div>

                    <div class="form-card" style="margin-top:12px; padding:12px;">
                        <h3 style="margin:0 0 8px 0; font-size:16px;">Printers for this Hospital</h3>
                        <div id="printersContainer"></div>
                        <div style="margin-top:8px;">
                            <button class="btn btn-secondary" type="button" onclick="addPrinterRow()">+ Add Printer</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="hospitalAddress" placeholder="Full address"></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="addHospital()">‚úÖ Save / Update Hospital</button>
                        <button class="btn btn-secondary" onclick="clearHospitalForm()">üîÑ Clear</button>
                    </div>
                    <div id="hospitalAlert" style="margin-top:10px;"></div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <h2 class="section-title" style="margin: 0; flex: 1;">üìã Saved Hospitals</h2>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn btn-secondary" id="btnHospitalList" onclick="toggleSection('hospitalListSection','btnHospitalList','List')">Show List</button>
                        <button class="btn btn-primary" onclick="document.getElementById('hospitalImportFile').click()">üì• Import from Excel</button>
                        <input type="file" id="hospitalImportFile" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleHospitalImport(event)">
                        <button class="btn btn-success" id="hospitalAddAllBtn" style="display:none; margin-left:6px;" onclick="performAddAllHospitals()">ADD ALL</button>            
                    </div>
                </div>
                <div id="hospitalListSection" style="display: none;">
                    <div class="search-box">
                        <input type="text" class="search-input" id="hospitalSearch" placeholder="Search hospital, city, contact..." onkeyup="filterHospitalTable()">
                        <button class="btn btn-secondary" onclick="filterHospitalTableAdvanced()">üîç Search</button>
                        <button class="btn btn-secondary" onclick="exportHospitalsToExcel()">üì• Export Excel</button>
                    </div>
                    <div class="table-wrapper" style="margin-top:12px;">
                        <table id="hospitalTable">
                            <thead>
                                 <tr>
                                      <th>Hospital Name</th>
                                      <th>Full Address</th>
                                      <th>City</th>
                                      <th>Pincode</th>
                                      <th>Total Printers</th>
                                      <th>Printer Name</th>
                                      <th>Printer Serial</th>
                                      <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="hospitalTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 5 ARCHIVE & SUMMARY -->
            <div id="archive-summary" class="tab-content">
                <h2 class="section-title">üì¶ Archive & Summary</h2>
                
                <!-- CURRENT MONTH INFO -->
                <div class="form-card" style="background: linear-gradient(135deg, #E0F2FE 0%, #F0FDFA 100%); border-left: 5px solid var(--primary);">
                    <h3 style="color: var(--primary); margin-bottom: 12px;">üìÖ Current Month Status</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Current Active Month</label>
                            <input type="month" id="currentActiveMonth" disabled style="background: white; font-weight: 700;">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-warning" onclick="archiveCurrentMonth()" style="margin-top: 23px; width: 100%;">üì¶ Archive Current Month</button>
                        </div>
                    </div>
                    <div id="currentMonthSummary" style="background: white; padding: 14px; border-radius: 10px; margin-top: 12px; font-size: 13px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <div><strong>Stock IN Entries:</strong> <span id="currentCreditCount" style="color: var(--success); font-weight: 700;">0</span></div>
                            <div><strong>Stock IN Total Units:</strong> <span id="currentTotalIn" style="color: var(--success); font-weight: 700;">0</span></div>
                            <div><strong>Dispatch OUT Entries:</strong> <span id="currentDispatchCount" style="color: var(--danger); font-weight: 700;">0</span></div>
                            <div><strong>Dispatch OUT Total Units:</strong> <span id="currentTotalOut" style="color: var(--danger); font-weight: 700;">0</span></div>
                        </div>
                    </div>
                </div>

                <!-- CURRENT MONTH STOCK IN -->
                <div style="margin-top: 24px;">
                    <div class="section-title">
                        <span>üìä Stock IN Records (Slide to see all ‚Üí)</span>
                        <button class="btn btn-secondary" id="btnCurrentCreditHistory" onclick="toggleSection('currentCreditSection','btnCurrentCreditHistory','History')">Show History</button>
                    </div>
                    <div id="currentCreditSection" style="display: none;">
                        <div class="search-box">
                            <input type="text" class="search-input" id="archiveStockSearch" placeholder="Search..." onkeyup="filterArchiveStockTable()">
                            <button class="btn btn-secondary" onclick="filterArchiveStockTableAdvanced()">üîç Search</button>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th><th>Month</th><th>A4-210</th><th>A3-210</th><th>13x17</th><th>A4-180</th><th>8x10</th><th>8x10M</th><th>A3M</th><th>A4M</th><th>A4-130</th><th>A4-210</th><th>Black</th><th>Yel</th><th>Cyan</th><th>Mag</th><th>500ML</th><th>Gary</th><th>CC</th><th>CM</th><th>CY</th><th>CG</th><th>Total</th><th class="notes-column">Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="currentCreditStockTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CURRENT MONTH DISPATCH -->
                <div style="margin-top: 24px;">
                    <div class="section-title">
                        <span>üè• Hospital-wise Dispatch Records (Slide to see all ‚Üí)</span>
                        <button class="btn btn-secondary" id="btnCurrentDispatchHistory" onclick="toggleSection('currentDispatchSection','btnCurrentDispatchHistory','History')">Show History</button>
                    </div>
                    <div id="currentDispatchSection" style="display: none;">
                        <div class="search-box">
                            <input type="text" class="search-input" id="archiveDispatchSearch" placeholder="Search..." onkeyup="filterArchiveDispatchTable()">
                            <button class="btn btn-secondary" onclick="filterArchiveDispatchTableAdvanced()">üîç Search</button>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Hospital Name</th><th>Location</th><th>A4-210</th><th>A3-210</th><th>13x17</th><th>A4-180</th><th>8x10</th><th>8x10M</th><th>A3M</th><th>A4M</th><th>A4-130</th><th>A4-210</th><th>Black</th><th>Yel</th><th>Cyan</th><th>Mag</th><th>500ML</th><th>Gary</th><th>CC</th><th>CM</th><th>CY</th><th>CG</th><th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="currentDispatchTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ARCHIVED MONTHS -->
                <h3 class="section-title" style="margin-top: 24px;">üì¶ Archived Previous Months</h3>
                <div class="form-card">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label>Select Archive Month to View</label>
                        <select id="archiveMonthSelector" onchange="showArchivedMonthData()">
                            <option value="">-- Select Month --</option>
                        </select>
                    </div>
                    <div id="archiveDetailBox" class="hidden-content">
                        <div style="background: white; padding: 14px; border-radius: 10px; border: 2px solid var(--primary); margin-bottom: 14px;">
                            <h4 style="color: var(--primary); margin-bottom: 12px;">Archive Details - <span id="archiveMonthLabel"></span></h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                <div><strong>Stock IN Entries:</strong> <span id="archiveCreditCount" style="color: var(--success); font-weight: 700;">0</span></div>
                                <div><strong>Stock IN Total Units:</strong> <span id="archiveTotalIn" style="color: var(--success); font-weight: 700;">0</span></div>
                                <div><strong>Dispatch OUT Entries:</strong> <span id="archiveDispatchCount" style="color: var(--danger); font-weight: 700;">0</span></div>
                                <div><strong>Dispatch OUT Total Units:</strong> <span id="archiveTotalOut" style="color: var(--danger); font-weight: 700;">0</span></div>
                            </div>
                        </div>

                        <!-- MATERIAL SUMMARY -->
                        <div style="margin-top: 14px;">
                            <h4 style="color: var(--primary); margin-bottom: 12px; font-size: 15px;">üìä Material-Wise Summary (Slide to see all ‚Üí)</h4>
                            <div class="material-summary-scroll" id="archiveMaterialSummary"></div>
                        </div>

                        <!-- ARCHIVE STOCK IN -->
                        <div style="margin-top: 14px;">
                            <div class="section-title">
                                <span>üìä Stock IN Records</span>
                                <button class="btn btn-secondary" id="btnArchiveCreditHistory" onclick="toggleSection('archiveCreditHistorySection','btnArchiveCreditHistory','History')">Show History</button>
                            </div>
                            <div id="archiveCreditHistorySection" style="display: none;">
                                <div class="search-box">
                                    <input type="text" class="search-input" id="archivedCreditSearch" placeholder="Search..." onkeyup="filterArchivedCreditTable()">
                                    <button class="btn btn-secondary" onclick="filterArchivedCreditTableAdvanced()">üîç Search</button>
                                </div>
                                <div class="table-wrapper">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th><th>Month</th><th>A4-210</th><th>A3-210</th><th>13x17</th><th>A4-180</th><th>8x10</th><th>8x10M</th><th>A3M</th><th>A4M</th><th>A4-130</th><th>A4-210</th><th>Black</th><th>Yel</th><th>Cyan</th><th>Mag</th><th>500ML</th><th>Gary</th><th>CC</th><th>CM</th><th>CY</th><th>CG</th><th>Total</th><th class="notes-column">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="archiveCreditStockTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- ARCHIVE DISPATCH -->
                        <div style="margin-top: 14px;">
                            <div class="section-title">
                                <span>üè• Hospital-wise Dispatch Records</span>
                                <button class="btn btn-secondary" id="btnArchiveDispatchHistory" onclick="toggleSection('archiveDispatchHistorySection','btnArchiveDispatchHistory','History')">Show History</button>
                            </div>
                            <div id="archiveDispatchHistorySection" style="display: none;">
                                <div class="search-box">
                                    <input type="text" class="search-input" id="archivedDispatchSearch" placeholder="Search..." onkeyup="filterArchivedDispatchTable()">
                                    <button class="btn btn-secondary" onclick="filterArchivedDispatchTableAdvanced()">üîç Search</button>
                                </div>
                                <div class="table-wrapper">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Hospital Name</th><th>Location</th><th>A4-210</th><th>A3-210</th><th>13x17</th><th>A4-180</th><th>8x10</th><th>8x10M</th><th>A3M</th><th>A4M</th><th>A4-130</th><th>A4-210</th><th>Black</th><th>Yel</th><th>Cyan</th><th>Mag</th><th>500ML</th><th>Gary</th><th>CC</th><th>CM</th><th>CY</th><th>CG</th><th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="archiveDispatchTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 6 MONTHLY COUNTER -->
            <div id="monthly-counter" class="tab-content">
                <div class="counter-container">
                    <div class="container">
                        <h1>üìü Opening / Closing Counter (Hospital + Printer Wise)</h1>

                        <!-- ========== ENTRY FORM ========== -->
                        <div class="form-card">
                            <h2>‚ûï Add / Edit Counter Entry</h2>
                            <p class="small-note">
                                One record per Hospital + Printer + Month. Opening values for a new month come from the previous month's closing (same hospital & printer).
                            </p>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Month (YYYY-MM)</label>
                                    <input type="month" id="ctrMonth">
                                </div>
                                <div class="form-group">
                                    <label>Hospital</label>
                                    <select id="ctrHospital">
                                        <option value="">-- Select Hospital --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Custom Hospital Name (for "Other")</label>
                                    <input type="text" id="ctrHospitalCustom" placeholder="Type hospital name here" disabled>
                                </div>
                            </div>

                            <!-- PRINTER DETAILS -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Printer Model</label>
                                    <input type="text" id="ctrPrinterModel" placeholder="e.g. Canon XYZ-123">
                                </div>
                                <div class="form-group">
                                    <label>Printer Serial No.</label>
                                    <input type="text" id="ctrPrinterSerial" placeholder="Serial number">
                                </div>
                            </div>

                            <!-- A4 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Opening A4</label>
                                    <input type="number" id="ctrOpenA4" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Closing A4</label>
                                    <input type="number" id="ctrCloseA4" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Used A4 (Auto)</label>
                                    <input type="number" id="ctrUsedA4" readonly>
                                </div>
                            </div>

                            <!-- A3 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Opening A3</label>
                                    <input type="number" id="ctrOpenA3" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Closing A3</label>
                                    <input type="number" id="ctrCloseA3" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Used A3 (Auto)</label>
                                    <input type="number" id="ctrUsedA3" readonly>
                                </div>
                            </div>

                            <!-- 13x17 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Opening 13x17</label>
                                    <input type="number" id="ctrOpen13" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Closing 13x17</label>
                                    <input type="number" id="ctrClose13" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Used 13x17 (Auto)</label>
                                    <input type="number" id="ctrUsed13" readonly>
                                </div>
                            </div>

                            <!-- 8x10 -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Opening 8x10</label>
                                    <input type="number" id="ctrOpen8x10" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Closing 8x10</label>
                                    <input type="number" id="ctrClose8x10" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Used 8x10 (Auto)</label>
                                    <input type="number" id="ctrUsed8x10" readonly>
                                </div>
                            </div>

                            <!-- TOGGLE BUTTON FOR OTHER OPTIONS -->
                            <div class="btn-group">
                                <button class="btn-secondary" type="button" id="toggleOthersBtn">‚ûï Show Other Options</button>
                            </div>

                            <!-- OTHER OPTIONS BLOCK (HIDDEN BY DEFAULT) -->
                            <div id="otherOptionsBlock" style="display:none; margin-top:10px;">
                                <!-- OTHER 1 -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Other 1 Name</label>
                                        <input type="text" id="ctrOther1Name" placeholder="Example: Film Roll, Plate, etc.">
                                    </div>
                                    <div class="form-group">
                                        <label>Opening Other 1</label>
                                        <input type="number" id="ctrOpenOther1" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Closing Other 1</label>
                                        <input type="number" id="ctrCloseOther1" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Used Other 1 (Auto)</label>
                                        <input type="number" id="ctrUsedOther1" readonly>
                                    </div>
                                </div>

                                <!-- OTHER 2 -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Other 2 Name</label>
                                        <input type="text" id="ctrOther2Name" placeholder="Custom option 2">
                                    </div>
                                    <div class="form-group">
                                        <label>Opening Other 2</label>
                                        <input type="number" id="ctrOpenOther2" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Closing Other 2</label>
                                        <input type="number" id="ctrCloseOther2" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Used Other 2 (Auto)</label>
                                        <input type="number" id="ctrUsedOther2" readonly>
                                    </div>
                                </div>

                                <!-- OTHER 3 -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Other 3 Name</label>
                                        <input type="text" id="ctrOther3Name" placeholder="Custom option 3">
                                    </div>
                                    <div class="form-group">
                                        <label>Opening Other 3</label>
                                        <input type="number" id="ctrOpenOther3" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Closing Other 3</label>
                                        <input type="number" id="ctrCloseOther3" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Used Other 3 (Auto)</label>
                                        <input type="number" id="ctrUsedOther3" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Total Used (A4 + A3 + 13x17 + 8x10 + Others)</label>
                                    <input type="number" id="ctrUsedTotal" readonly>
                                </div>
                            </div>

                            <div class="btn-group">
                                <button class="btn-success" id="ctrBtnSave">‚úÖ Save / Update Entry</button>
                                <button class="btn-secondary" id="ctrBtnClear">üîÑ New / Clear Form</button>
                            </div>
                            <div id="ctrAlert"></div>
                        </div>

                        <!-- ========== COUNTER VIEW ========== -->
                        <div class="form-card section-line">
                            <h2>üîç Counter View (Month Range + Hospital)</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Month</label>
                                    <input type="month" id="ctrFilterMonthFrom">
                                </div>
                                <div class="form-group">
                                    <label>To Month</label>
                                    <input type="month" id="ctrFilterMonthTo">
                                </div>
                                <div class="form-group">
                                    <label>Hospital Filter</label>
                                    <select id="ctrFilterHospital">
                                        <option value="">All Hospitals</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <div class="btn-group">
                                        <button class="btn-primary" id="ctrBtnShow">Show</button>
                                        <button class="btn-secondary" id="ctrBtnExport">Export PDF</button>
                                    </div>
                                </div>
                            </div>

                            <div class="table-wrapper">
                                <table id="ctrTable">
                                    <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Hospital</th>
                                        <th>Printer Model</th>
                                        <th>Printer Serial</th>
                                        <th>Used A4</th>
                                        <th>Used A3</th>
                                        <th>Used 13x17</th>
                                        <th>Used 8x10</th>
                                        <th>Other 1</th>
                                        <th>Other 2</th>
                                        <th>Other 3</th>
                                        <th>Total Used</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                    <tbody id="ctrTableBody"></tbody>
                                    <tfoot>
                                    <tr>
                                        <td colspan="4">TOTAL (for selected filter)</td>
                                        <td id="ctrTotalA4">0</td>
                                        <td id="ctrTotalA3">0</td>
                                        <td id="ctrTotal13">0</td>
                                        <td id="ctrTotal8x10">0</td>
                                        <td id="ctrTotalOther1">0</td>
                                        <td id="ctrTotalOther2">0</td>
                                        <td id="ctrTotalOther3">0</td>
                                        <td id="ctrTotalUsed" class="total-column">0</td>
                                        <td></td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                </div><!-- end container -->
            </div><!-- end content -->
        </div><!-- end main-wrapper -->
    </div><!-- end mainApp -->

    <!-- PASSWORD VERIFICATION MODAL -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Confirm Delete</span>
                <button class="close-btn" onclick="closePasswordModal()">‚úï</button>
            </div>
            <div class="form-group">
                <label>Please enter your password to delete this entry.</label>
                <input type="password" id="verifyPassword" placeholder="Password">
            </div>
            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="verifyAndDelete()">‚úÖ Confirm Delete</button>
                <button class="btn btn-secondary" onclick="closePasswordModal()">‚ùå Cancel</button>
            </div>
            <div id="passwordAlert" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        /* ===== LOCAL STORAGE LOAD ===== */
        function loadFromStorage() {
            const savedData = localStorage.getItem('ms_stock_data');
            if (savedData) {
                data = JSON.parse(savedData);
                // Normalize/upgrade older data formats: ensure arrays exist and numeric fields
                if (!data.dispatches) data.dispatches = [];
                if (!data.credits) data.credits = [];
                const dispatchFields = ['a4210','a3210','dispatch13x17Film','a4180','film','film8x10Macron','filmA3Macrone','filmA4Macrom','a4130GSM','a4Film210GSM','black','yellow','cyan','megenta','black500ml','garyInk','canonCyan','canonMagenta','canonYellow','canonGray'];
                data.dispatches = (data.dispatches || []).map(d => {
                    // migrate possible old key
                    if (d && d.credit13x17Film && !d.dispatch13x17Film) d.dispatch13x17Film = d.credit13x17Film;
                    dispatchFields.forEach(f => { if (d) d[f] = parseInt(d[f] || 0); });
                    return d || {};
                });
                // normalize credits numeric values as well
                const creditFields = ['a4210','a3210','credit13x17Film','a4180','film','film8x10Macron','filmA3Macrone','filmA4Macrom','a4130GSM','a4Film210GSM','black','yellow','cyan','megenta','black500ml','garyInk','canonCyan','canonMagenta','canonYellow','canonGray'];
                data.credits = (data.credits || []).map(c => { creditFields.forEach(f => { if (c) c[f] = parseInt(c[f] || 0); }); return c || {}; });
                // Ensure hospitals array exists
                if (!data.hospitals) {
                    data.hospitals = [
                        { id: 1, name: 'City Hospital', location: 'Bhopal', contact: 'Dr. Sharma', mobile: '9999999999', printer: 'HP LaserJet', serial: 'SN123456', installDate: '2024-01-15', address: 'Main Road, Bhopal' },
                        { id: 2, name: 'Apollo Clinic', location: 'Indore', contact: 'Dr. Patel', mobile: '8888888888', printer: 'Canon Xerox', serial: 'SN789012', installDate: '2024-02-20', address: 'Hospital Road, Indore' },
                        { id: 3, name: 'Medcare Center', location: 'Jabalpur', contact: 'Dr. Singh', mobile: '7777777777', printer: 'Ricoh MP', serial: 'SN345678', installDate: '2024-03-10', address: 'Civil Line, Jabalpur' }
                    ];
                }
                if (!data.nextHospitalId) data.nextHospitalId = 4;
            }

            const savedUsers = localStorage.getItem('ms_users');
            if (savedUsers) users = JSON.parse(savedUsers);
            
            // Load delivery notes
            const savedDeliveryNotes = localStorage.getItem('ms_delivery_notes');
            if (savedDeliveryNotes) deliveryNotes = JSON.parse(savedDeliveryNotes);
        }

        function saveToStorage() {
            try {
                localStorage.setItem('ms_stock_data', JSON.stringify(data));
                localStorage.setItem('ms_users', JSON.stringify(users));
                localStorage.setItem('ms_delivery_notes', JSON.stringify(deliveryNotes));
            } catch (e) {
                console.error('Storage error:', e);
            }
        }

        // AUTH LOGIN DATA
        let users = [
            { userId: 'admin', password: 'admin123', name: 'Admin User', empCode: 'EMP001', phone: '9876543210' },
            { userId: 'user1', password: 'pass123', name: 'John Doe', empCode: 'EMP002', phone: '9876543211' },
            { userId: 'user2', password: 'test123', name: 'Priya Sharma', empCode: 'EMP003', phone: '9876543212' }
        ];
        let currentUser = null;
        let tempOtp = null;
        let tempOtpPurpose = null;
        let tempOtpPhone = null;
        let pendingDeleteAction = null;
        let editingCreditIndex = -1;
        let editingDispatchIndex = -1;
        let currentHospitalEditIndex = -1;
        let currentArchiveMonth = -1;

        // DELIVERY NOTE DATA
        let deliveryNotes = [];
        const COMPANY_NAME = "MS Stock Service'S";
        const COMPANY_GST = "123456";
        const COMPANY_ADDRESS = "MS Stock Service'S, Bhopal, Madhya Pradesh 462001";
        const COMPANY_PAN = "ABCDE1234F";

        const materialFields = [
            { key: 'a4210', label: 'A4-210 GSM' },
            { key: 'a3210', label: 'A3-210 GSM' },
            { key: 'credit13x17Film', label: '13x17 Film' },
            { key: 'a4180', label: 'A4-180 GSM' },
            { key: 'film', label: '8x10 Film' },
            { key: 'film8x10Macron', label: '8x10 Macron Weight' },
            { key: 'filmA3Macrone', label: 'A3 Macrone Weight' },
            { key: 'filmA4Macrom', label: 'A4 Macrom Weight' },
            { key: 'a4130GSM', label: 'A4 130GSM' },
            { key: 'a4Film210GSM', label: 'A4 Film 210GSM' },
            { key: 'black', label: 'Black Ink' },
            { key: 'yellow', label: 'Yellow Ink' },
            { key: 'cyan', label: 'Cyan Ink' },
            { key: 'megenta', label: 'Magenta Ink' },
            { key: 'black500ml', label: '500ML Black' },
            { key: 'garyInk', label: 'Gary Ink' },
            { key: 'canonCyan', label: 'Canon Cyan' },
            { key: 'canonMagenta', label: 'Canon Magenta' },
            { key: 'canonYellow', label: 'Canon Yellow' },
            { key: 'canonGray', label: 'Canon Gray' }
        ];

        // MAIN DATA FOR STOCK APP
        let data = {
            credits: [],
            dispatches: [],
            hospitals: [
                { id: 1, name: 'City Hospital', location: 'Bhopal', contact: 'Dr. Sharma', mobile: '9999999999', printer: 'HP LaserJet', serial: 'SN123456', installDate: '2024-01-15', address: 'Main Road, Bhopal' },
                { id: 2, name: 'Apollo Clinic', location: 'Indore', contact: 'Dr. Patel', mobile: '8888888888', printer: 'Canon Xerox', serial: 'SN789012', installDate: '2024-02-20', address: 'Hospital Road, Indore' },
                { id: 3, name: 'Medcare Center', location: 'Jabalpur', contact: 'Dr. Singh', mobile: '7777777777', printer: 'Ricoh MP', serial: 'SN345678', installDate: '2024-03-10', address: 'Civil Line, Jabalpur' }
            ],
            partsLog: [],
            archived: [
                {
                    month: '2025-11',
                    credits: [
                        { date: '2025-11-15', month: '2025-11', a4210: 200, a3210: 150, credit13x17Film: 75, a4180: 100, film: 50, film8x10Macron: 30, filmA3Macrone: 20, filmA4Macrom: 25, a4130GSM: 40, a4Film210GSM: 35, black: 80, yellow: 60, cyan: 70, megenta: 65, black500ml: 45, garyInk: 55, canonCyan: 40, canonMagenta: 35, canonYellow: 38, canonGray: 42, remark: 'Bhopal office' }
                    ],
                    dispatches: [
                        { date: '2025-11-20', hospital: 'City Hospital', location: 'Bhopal', a4210: 100, a3210: 75, dispatch13x17Film: 40, a4180: 50, film: 25, film8x10Macron: 15, filmA3Macrone: 10, filmA4Macrom: 12, a4130GSM: 20, a4Film210GSM: 18, black: 40, yellow: 30, cyan: 35, megenta: 32, black500ml: 22, garyInk: 27, canonCyan: 20, canonMagenta: 17, canonYellow: 19, canonGray: 21 },
                        { date: '2025-11-22', hospital: 'Apollo Clinic', location: 'Indore', a4210: 80, a3210: 60, dispatch13x17Film: 30, a4180: 40, film: 20, film8x10Macron: 12, filmA3Macrone: 8, filmA4Macrom: 10, a4130GSM: 15, a4Film210GSM: 14, black: 30, yellow: 22, cyan: 26, megenta: 24, black500ml: 16, garyInk: 20, canonCyan: 15, canonMagenta: 13, canonYellow: 14, canonGray: 16 }
                    ]
                }
            ],
            currentMonth: new Date().toISOString().slice(0, 7),
            nextHospitalId: 4
        };

        // COUNTER DATA
        let meterCounters = [];
        let currentEditIndex = -1;
        let isEditing = false;

        // Initialize app
        window.onload = function() {
            loadFromStorage();
            loadMeterCounters();

            setDefaultDates();
            generateMonthOptions();
            
            // Initialize dropdowns with a slight delay to ensure data is ready
            setTimeout(() => {
                updateDispatchHospitalDropdown();
                updatePartDispatchHospitalDropdown();
                updateCounterHospitalDropdown();
                updateCounterHospitalFilter();
            }, 100);
            
            updateCreditTable();
            updateDispatchTable();
            updateHospitalTable();
            updatePartsTable();
            updateCurrentStockDisplay();
            
            updatePartsStockCards();
            initializeArchiveView();
            initCounterPage();
            updateDeliveryNoteTable();
            // ensure printers UI has at least one row on load
            setTimeout(() => {
                const pc = document.getElementById('printersContainer');
                if (pc && pc.children.length === 0) addPrinterRow();
            }, 50);
                // üëá NEW: page load / refresh pe auto-login
    const savedUser = localStorage.getItem('ms_current_user');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            showMainApp();  // login screen hide + dashboard show
        } catch (e) {
            console.error('Error parsing saved user', e);
        }
    }
        };

        function loadMeterCounters() {
            try {
                const saved = localStorage.getItem('ms_hospital_meter_v2');
                if (saved) {
                    meterCounters = JSON.parse(saved) || [];
                } else {
                    meterCounters = [];
                }
            } catch (e) {
                meterCounters = [];
                console.error('localStorage load error:', e);
            }
        }

        function saveMeterCounters() {
            try {
                localStorage.setItem('ms_hospital_meter_v2', JSON.stringify(meterCounters));
            } catch (e) {
                console.error('localStorage save error:', e);
                showAlert('ctrAlert', 'Unable to save data locally. Please check browser settings.', 'error');
            }
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const month = new Date().toISOString().slice(0, 7);
            
            // Set today's date on all matching date inputs (handles duplicate IDs in multiple tabs)
            ['creditDate', 'dispatchDate', 'partCreditDate', 'partDispatchDate'].forEach(id => setTodayValue(id));

            document.getElementById('currentActiveMonth').value = month;
            ['ctrMonth', 'ctrFilterMonthFrom', 'ctrFilterMonthTo'].forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.value) el.value = month;
            });
        }

        // Helper: set given input id to today's date (YYYY-MM-DD)
        function setTodayValue(id) {
            try {
                // Handle duplicate IDs by selecting all elements with matching id attribute
                const els = Array.from(document.querySelectorAll('[id="' + id + '"]'));
                const today = new Date().toISOString().split('T')[0];
                els.forEach(el => { try { el.value = today; } catch(e){} });
            } catch (e) {}
        }

        function generateMonthOptions() {
            const sel = document.getElementById('creditMonth');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let html = '';
            for (let year = 2024; year <= 2030; year++) {
                months.forEach((m, i) => {
                    let mNum = (i + 1).toString().padStart(2, '0');
                    html += `<option value="${year}-${mNum}">${m} ${year}</option>`;
                });
            }
            sel.innerHTML = html;
            sel.value = new Date().toISOString().slice(0, 7);
        }

        // PASSWORD VERIFICATION
        function requestPasswordVerification(action, param1, param2 = null) {
            pendingDeleteAction = { action, param1, param2 };
            document.getElementById('verifyPassword').value = '';
            document.getElementById('passwordAlert').innerHTML = '';
            document.getElementById('passwordModal').style.display = 'flex';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            pendingDeleteAction = null;
        }

        function verifyAndDelete() {
            const password = document.getElementById('verifyPassword').value;
            if (!currentUser || !password) {
                document.getElementById('passwordAlert').innerHTML = '<div class="alert alert-error">Please enter your password to delete the entry.</div>';
                return;
            }

            const user = users.find(u => u.userId === currentUser.userId);
            if (!user || user.password !== password) {
                document.getElementById('passwordAlert').innerHTML = '<div class="alert alert-error">Incorrect password. Entry not deleted.</div>';
                return;
            }

            if (pendingDeleteAction.action === 'deleteCredit') {
                data.credits.splice(pendingDeleteAction.param1, 1);
                updateCreditTable();
                updateCurrentStockDisplay();
                updateMaterialWiseSummary();
                updateIncomingHistory();
                updateArchiveView();
                saveToStorage();
                showAlert('creditAlert', 'Entry deleted!', 'success');
            } else if (pendingDeleteAction.action === 'deleteDispatch') {
                data.dispatches.splice(pendingDeleteAction.param1, 1);
                updateDispatchTable();
                updateCurrentStockDisplay();
                updateMaterialWiseSummary();
                updateOutgoingHistory();
                updateArchiveView();
                saveToStorage();
                showAlert('dispatchAlert', 'Entry deleted!', 'success');
            } else if (pendingDeleteAction.action === 'deleteHospital') {
                data.hospitals.splice(pendingDeleteAction.param1, 1);
                updateDispatchHospitalDropdown();
                updatePartDispatchHospitalDropdown();
                updateHospitalTable();
                showAlert('hospitalAlert', 'Hospital deleted!', 'success');
            } else if (pendingDeleteAction.action === 'deletePartLog') {   // üëà parts delete ke liye
                data.partsLog.splice(pendingDeleteAction.param1, 1);
                updatePartsTable();
                updatePartsStockCards();
                saveToStorage();
                showAlert('partsAlert', 'Part log deleted!', 'success');
            }   
                saveToStorage();
            closePasswordModal();
        }

        // AUTH FUNCTIONS
        function showAuthTab(which) {
            ['authLogin', 'authRegister', 'authForgot'].forEach(id => document.getElementById(id).classList.remove('active'));
            document.getElementById('auth' + which.charAt(0).toUpperCase() + which.slice(1)).classList.add('active');
            ['tabLogin', 'tabRegister', 'tabForgot'].forEach(id => document.getElementById(id).classList.remove('active'));
            if (which === 'login') document.getElementById('tabLogin').classList.add('active');
            if (which === 'register') document.getElementById('tabRegister').classList.add('active');
            if (which === 'forgot') document.getElementById('tabForgot').classList.add('active');
        }

        function showMainApp() {
            const auth = document.getElementById('authWrapper');
            const app = document.getElementById('mainApp');
            if (auth) auth.style.display = 'none';
            if (app) app.style.display = 'flex';
            if (currentUser) document.getElementById('currentUserInfo').innerText = `${currentUser.name} (${currentUser.empCode})`;
        }

        function showAuthMessage(msg, type = 'error') {
            const div = document.getElementById('authAlert');
            if (!div) return;
            div.innerHTML = `<div class="alert ${type === 'success' ? 'alert-success' : 'alert-error'}">${msg}</div>`;
            setTimeout(() => div.innerHTML = '', 4000);
        }

        function generateOtp() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function requestOtp(purpose) {
            const phoneReg = document.getElementById('regPhone');
            const phoneFp = document.getElementById('fpPhone');
            let phone;
            
            if (purpose === 'register') {
                phone = phoneReg.value.trim();
                if (phone.length !== 10) {
                    showAuthMessage('Sahi phone number daaliye! 10 digit hona chaiye.');
                    return;
                }
                tempOtp = generateOtp();
                tempOtpPurpose = 'register';
                tempOtpPhone = phone;
                document.getElementById('otpInfoRegister').innerText = `Demo OTP: ${tempOtp}`;
                showAuthMessage(`OTP generate ho gaya! Demo OTP: ${tempOtp}`, 'success');
            } else if (purpose === 'forgot') {
                phone = phoneFp.value.trim();
                if (phone.length !== 10) {
                    showAuthMessage('Sahi phone number daaliye! 10 digit hona chaiye.');
                    return;
                }
                tempOtp = generateOtp();
                tempOtpPurpose = 'forgot';
                tempOtpPhone = phone;
                document.getElementById('otpInfoForgot').innerText = `Demo OTP: ${tempOtp}`;
                showAuthMessage(`OTP generate ho gaya! Demo OTP: ${tempOtp}`, 'success');
            }
        }

        function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const empCode = document.getElementById('regEmpCode').value.trim();
            const userId = document.getElementById('regUserId').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const otp = document.getElementById('regOtp').value.trim();
            const pass1 = document.getElementById('regPassword').value;
            const pass2 = document.getElementById('regPassword2').value;

            if (!name || !empCode || !userId || !phone || !otp || !pass1 || !pass2) {
                showAuthMessage('Sab field bharna jaruri hai.');
                return;
            }

            if (pass1 !== pass2) {
                showAuthMessage('Password aur confirm password match nahi ho raha.');
                return;
            }

            if (!tempOtp || tempOtpPurpose !== 'register' || tempOtpPhone !== phone || tempOtp !== otp) {
                showAuthMessage('OTP galat ya expire ho gaya.');
                return;
            }

            if (users.find(u => u.userId.toLowerCase() === userId.toLowerCase())) {
                showAuthMessage('Ye User ID pehle se registered hai.');
                return;
            }

            const user = { name, empCode, userId, phone, password: pass1 };
            users.push(user);
            saveToStorage();
            currentUser = { userId: user.userId, name: user.name, empCode: user.empCode, phone: user.phone };
            tempOtp = null;
            tempOtpPhone = null;
            tempOtpPurpose = null;
            showAuthMessage('Account create ho gaya!', 'success');
            setTimeout(() => showMainApp(), 1000);
        }

        function handleLogin() {
            const uidOrPhone = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPassword').value;

            if (!uidOrPhone || !pass) {
                showAuthMessage('User ID/Phone aur Password dono jaruri hai.');
                return;
            }

            const user = users.find(u => u.userId.toLowerCase() === uidOrPhone.toLowerCase() || u.phone === uidOrPhone);

            if (!user || user.password !== pass) {
                showAuthMessage('User ID/Phone ya Password galat hai.');
                return;
            }

            currentUser = { userId: user.userId, name: user.name, empCode: user.empCode, phone: user.phone };
            localStorage.setItem('ms_current_user', JSON.stringify(currentUser));
            showAuthMessage('Login successful!', 'success');
            setTimeout(() => showMainApp(), 500);
        }

        function handleResetPassword() {
            const userId = document.getElementById('fpUserId').value.trim();
            const phone = document.getElementById('fpPhone').value.trim();
            const otp = document.getElementById('fpOtp').value.trim();
            const newPass = document.getElementById('fpNewPassword').value;

            if (!userId || !phone || !otp || !newPass) {
                showAuthMessage('Sab field bharna jaruri hai.');
                return;
            }

            const userIndex = users.findIndex(u => u.userId.toLowerCase() === userId.toLowerCase() && u.phone === phone);

            if (userIndex === -1) {
                showAuthMessage('User ID aur Phone match nahi ho raha.');
                return;
            }

            if (!tempOtp || tempOtpPurpose !== 'forgot' || tempOtpPhone !== phone || tempOtp !== otp) {
                showAuthMessage('OTP galat ya expire ho gaya.');
                return;
            }

            users[userIndex].password = newPass;
            saveToStorage();
            tempOtp = null;
            tempOtpPhone = null;
            tempOtpPurpose = null;
            showAuthMessage('Password reset ho gaya!', 'success');
            setTimeout(() => showAuthTab('login'), 1000);
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('ms_current_user');
            const auth = document.getElementById('authWrapper');
            const app = document.getElementById('mainApp');
            if (app) app.style.display = 'none';
            if (auth) auth.style.display = 'flex';
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // STOCK APP FUNCTIONS
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.sidebar-btn-action').forEach(b => b.classList.remove('active'));
            
            // Show the selected tab
            const tabElement = document.getElementById(tabId);
            if (tabElement) tabElement.classList.add('active');
            
            // Update sidebar button active state
            document.querySelectorAll('.sidebar-btn, .sidebar-btn-action').forEach((btn) => {
                const onclick = btn.getAttribute('onclick') || '';
                if (onclick.includes(`'${tabId}'`) || onclick.includes(`"${tabId}"`)) {
                    btn.classList.add('active');
                }
            });
            
            // Call update functions for tabs that need it
            if (tabId === 'dashboard') {
                updateCurrentStockDisplay();
                updateMaterialWiseSummary();
            }
            if (tabId === 'credit-dispatch') {
                updateCreditTable();
            }
            if (tabId === 'incoming-form') {
                // Ensure date defaults to today when opening the incoming form
                setTodayValue('creditDate');
                updateIncomingHistory();
            }
            if (tabId === 'outgoing-form') {
                // Ensure date defaults to today when opening the outgoing form
                setTodayValue('dispatchDate');
                updateDispatchHospitalDropdown();
                updateOutgoingHistory();
            }
            if (tabId === 'dispatch-history') {
                updateDispatchTable();
            }
            if (tabId === 'archive-summary') {
                updateArchiveView();
            }
            if (tabId === 'monthly-counter') {
                updateCounterTable();
            }
            if (tabId === 'delivery-note') {
                updateDeliveryNoteTable();
            }
            
            saveToStorage();
        }

        // SIDEBAR ACTION BUTTONS
        function switchToIncoming() {
            switchTab('incoming-form');
        }

        function switchToOutgoing() {
            switchTab('outgoing-form');
        }

        function showAlert(targetId, msg, type = 'error') {
            const div = document.getElementById(targetId);
            if (!div) return;
            div.innerHTML = `<div class="alert ${type === 'success' ? 'alert-success' : 'alert-error'}">${msg}</div>`;
            setTimeout(() => div.innerHTML = '', 3500);
        }

        function toggleSection(sectionId, btnId, labelBase) {
            const sec = document.getElementById(sectionId);
            const btn = document.getElementById(btnId);
            if (!sec || !btn) return;
            const isHidden = sec.style.display === 'none';
            sec.style.display = isHidden ? 'block' : 'none';
            btn.innerText = isHidden ? `Hide ${labelBase}` : `Show ${labelBase}`;
        }

        // DELIVERY NOTE FUNCTIONS
        function getNextDeliveryNoteNo() {
            let lastNo = localStorage.getItem("lastDeliveryNoteNo");
            if (!lastNo) {
                lastNo = 1;
            } else {
                lastNo = parseInt(lastNo, 10) + 1;
            }
            localStorage.setItem("lastDeliveryNoteNo", String(lastNo));
            return "DN-" + String(lastNo).padStart(4, "0");
        }

        function createDeliveryNoteFromDispatch(dispatchData) {
            // Get hospital details
            const hospital = data.hospitals.find(h => h.name === dispatchData.hospital);
            
            // Create materials list - only include items with quantity > 0
            const materials = [];
            
            // Map dispatch fields to material descriptions
            const materialMapping = [
                { key: 'a4210', label: 'A4-210 GSM' },
                { key: 'a3210', label: 'A3-210 GSM' },
                { key: 'dispatch13x17Film', label: '13x17 Film' },
                { key: 'a4180', label: 'A4-180 GSM' },
                { key: 'film', label: '8x10 Film' },
                { key: 'film8x10Macron', label: '8x10 Macron Weight' },
                { key: 'filmA3Macrone', label: 'A3 Macrone Weight' },
                { key: 'filmA4Macrom', label: 'A4 Macrom Weight' },
                { key: 'a4130GSM', label: 'A4 130GSM' },
                { key: 'a4Film210GSM', label: 'A4 Film 210GSM' },
                { key: 'black', label: 'Black Ink' },
                { key: 'yellow', label: 'Yellow Ink' },
                { key: 'cyan', label: 'Cyan Ink' },
                { key: 'megenta', label: 'Magenta Ink' },
                { key: 'black500ml', label: '500ML Black' },
                { key: 'garyInk', label: 'Gary Ink' },
                { key: 'canonCyan', label: 'Canon Cyan' },
                { key: 'canonMagenta', label: 'Canon Magenta' },
                { key: 'canonYellow', label: 'Canon Yellow' },
                { key: 'canonGray', label: 'Canon Gray' }
            ];

            materialMapping.forEach(mapping => {
                const qty = parseInt(dispatchData[mapping.key] || 0);
                if (qty > 0) {
                    materials.push({
                        description: mapping.label,
                        quantity: qty
                    });
                }
            });

            const deliveryNote = {
                deliveryNoteNo: getNextDeliveryNoteNo(),
                date: dispatchData.date,
                hospitalName: dispatchData.hospital,
                hospitalLocation: dispatchData.location,
                printerModel: hospital ? hospital.printer : 'N/A',
                printerSerial: hospital ? hospital.serial : 'N/A',
                materials: materials,
                totalItems: materials.length,
                totalQuantity: materials.reduce((sum, item) => sum + item.quantity, 0),
                createdAt: new Date().toISOString()
            };

            // Save delivery note
            deliveryNotes.push(deliveryNote);
            saveToStorage();

            // Generate PDF
            generateDeliveryNotePDF(deliveryNote);

            return deliveryNote;
        }

        function generateDeliveryNotePDF(deliveryNote) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // ===== TITLE =====
            doc.setFontSize(14);
            doc.text("DELIVERY NOTE", 105, 12, { align: "center" });

            // ===== TOP LEFT: COMPANY BOX =====
            doc.setFontSize(9);
            doc.rect(10, 16, 110, 36);  // x, y, width, height

            let y = 20;
            doc.setFont(undefined, "bold");
            doc.text(COMPANY_NAME, 12, y);
            doc.setFont(undefined, "normal");
            y += 5;
            doc.text(COMPANY_ADDRESS, 12, y, { maxWidth: 106 });
            y += 10;
            doc.text("GSTIN/UIN : " + COMPANY_GST, 12, y);
            y += 5;
            doc.text("State Name : Madhya Pradesh, Code : 23", 12, y);

            // ===== TOP RIGHT: INFO TABLE (Delivery No, Date, etc.) =====
            doc.rect(120, 16, 80, 36);

            let xL = 122;
            let xR = 198;
            y = 22;

            doc.text("Delivery Note No.", xL, y);
            doc.text(deliveryNote.deliveryNoteNo || "-", xR, y, { align: "right" });

            y += 6;
            doc.text("Dated", xL, y);
            doc.text(deliveryNote.date || "-", xR, y, { align: "right" });

            y += 6;
            doc.text("Mode/Terms of Payment", xL, y);

            y += 6;
            doc.text("Other References", xL, y);

            // ===== BUYER (BILL TO) LEFT BOX =====
            doc.rect(10, 52, 110, 28);
            doc.setFontSize(9);
            doc.text("Buyer (Bill to)", 12, 57);

            doc.setFont(undefined, "bold");
            doc.text(deliveryNote.hospitalName || "-", 12, 63, { maxWidth: 106 });
            doc.setFont(undefined, "normal");

            doc.text(deliveryNote.hospitalLocation || "-", 12, 69, { maxWidth: 106 });

            // ===== PRINTER DETAILS =====
            doc.rect(120, 52, 80, 28);
            xL = 122;
            y  = 58;

            doc.text("Printer Model", xL, y);
            doc.text(deliveryNote.printerModel || "-", xR, y, { align: "right" });

            y += 6;
            doc.text("Serial No.", xL, y);
            doc.text(deliveryNote.printerSerial || "-", xR, y, { align: "right" });

            // ===== DESTINATION / TERMS =====
            doc.rect(10, 80, 110, 10);
            doc.rect(120, 80, 80, 10);
            doc.text("Destination", 12, 87);
            doc.text("Terms of Delivery", 122, 87);

            // ===== GOODS TABLE =====
            const goodsTop = 96;
            const goodsHeight = 80;
            doc.rect(10, goodsTop, 190, goodsHeight);

            // Column lines (Sr | Desc | Qty | Rate | per | Disc | Amount)
            doc.line(20, goodsTop, 20, goodsTop + goodsHeight);
            doc.line(118, goodsTop, 118, goodsTop + goodsHeight);
            doc.line(138, goodsTop, 138, goodsTop + goodsHeight);
            doc.line(152, goodsTop, 152, goodsTop + goodsHeight);
            doc.line(166, goodsTop, 166, goodsTop + goodsHeight);
            doc.line(184, goodsTop, 184, goodsTop + goodsHeight);

            // Header row
            let headerY = goodsTop + 6;
            doc.setFontSize(9);
            doc.text("Sl", 12, headerY);
            doc.text("Description of Goods", 24, headerY);
            doc.text("Quantity", 120, headerY);
            doc.text("Rate", 140, headerY);
            doc.text("per", 154, headerY);
            doc.text("Disc. %", 170, headerY);
            doc.text("Amount", 196, headerY, { align: "right" });

            // Header bottom line
            doc.line(10, goodsTop + 8, 200, goodsTop + 8);

            // Material rows
            let rowY = goodsTop + 15;
            let totalQty = 0;

            (deliveryNote.materials || []).forEach((material, i) => {
                if (rowY > goodsTop + goodsHeight - 10) return; // overflow safety
                doc.text(String(i + 1), 12, rowY);
                doc.text(material.description, 22, rowY, { maxWidth: 94 });
                doc.text(String(material.quantity), 126, rowY, { align: "right" });
                doc.text("nos", 154, rowY);
                doc.text("", 198, rowY, { align: "right" });
                totalQty += Number(material.quantity || 0);
                rowY += 6;
            });

            // TOTAL row
            const totalY = goodsTop + goodsHeight - 6;
            doc.text("Total", 120, totalY);
            doc.text(String(totalQty) + " nos", 198, totalY, { align: "right" });

            // ===== TAX / TOTAL VALUE BOX =====
            const taxTop = goodsTop + goodsHeight + 4;
            const taxHeight = 24;
            doc.rect(10, taxTop, 190, taxHeight);

            doc.text("Taxable Value", 160, taxTop + 7);
            doc.text("Total", 160, taxTop + 18);

            doc.text("Tax Amount (in words) : NIL", 12, taxTop + 18);

            // ===== PAN + SIGNATURE =====
            const panY = taxTop + taxHeight + 10;
            doc.text("Company's PAN : " + COMPANY_PAN, 12, panY);

            doc.text("Recd. in Good Condition", 12, 270);
            doc.text("for " + COMPANY_NAME, 140, 270);
            doc.text("Authorised Signatory", 140, 278);

            doc.setFontSize(8);
            doc.text(
                "This is a Computer Generated Document",
                105,
                292,
                { align: "center" }
            );

            const safeHospital = (deliveryNote.hospitalName || "").replace(/\s+/g, "_");
            doc.save(`Delivery_Note_${safeHospital}_${deliveryNote.date}.pdf`);
        }

        function updateDeliveryNoteTable() {
            const tbody = document.getElementById('deliveryNoteTableBody');
            tbody.innerHTML = '';
            
            deliveryNotes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            deliveryNotes.forEach((note, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${note.deliveryNoteNo}</td>
                    <td>${note.date}</td>
                    <td>${note.hospitalName}</td>
                    <td>${note.hospitalLocation}</td>
                    <td>${note.printerModel}</td>
                    <td>${note.printerSerial}</td>
                    <td style="text-align:right;">${note.totalItems}</td>
                    <td style="text-align:right;">${note.totalQuantity}</td>
                    <td>
                        <button class="btn-table btn-print" onclick="printDeliveryNote(${index})">üßæ Print</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (deliveryNotes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#999;">No delivery notes found</td></tr>';
            }
        }

        function printDeliveryNote(index) {
            const note = deliveryNotes[index];
            if (note) {
                generateDeliveryNotePDF(note);
            }
        }

        // STOCK APP FUNCTIONS CONTINUED...
        function addCreditEntry() {
            const entry = {
                date: document.getElementById('creditDate').value,
                month: document.getElementById('creditMonth').value,
                a4210: document.getElementById('creditA4210').value || 0,
                a3210: document.getElementById('creditA3210').value || 0,
                credit13x17Film: document.getElementById('credit13x17Film').value || 0,
                a4180: document.getElementById('creditA4180').value || 0,
                film: document.getElementById('creditFilm').value || 0,
                film8x10Macron: document.getElementById('creditFilm8x10Macron').value || 0,
                filmA3Macrone: document.getElementById('creditFilmA3Macrone').value || 0,
                filmA4Macrom: document.getElementById('creditFilmA4Macrom').value || 0,
                a4130GSM: document.getElementById('creditA4130GSM').value || 0,
                a4Film210GSM: document.getElementById('creditA4Film210GSM').value || 0,
                black: document.getElementById('creditBlack').value || 0,
                yellow: document.getElementById('creditYellow').value || 0,
                cyan: document.getElementById('creditCyan').value || 0,
                megenta: document.getElementById('creditMegenta').value || 0,
                black500ml: document.getElementById('creditBlack500ML').value || 0,
                garyInk: document.getElementById('creditGaryInk').value || 0,
                canonCyan: document.getElementById('creditCanonCyan').value || 0,
                canonMagenta: document.getElementById('creditCanonMagenta').value || 0,
                canonYellow: document.getElementById('creditCanonYellow').value || 0,
                canonGray: document.getElementById('creditCanonGray').value || 0,
                remark: document.getElementById('creditRemark').value
            };

            // Validation: at least one material quantity must be > 0
            const creditQtyKeys = ['a4210','a3210','credit13x17Film','a4180','film','film8x10Macron','filmA3Macrone','filmA4Macrom','a4130GSM','a4Film210GSM','black','yellow','cyan','megenta','black500ml','garyInk','canonCyan','canonMagenta','canonYellow','canonGray'];
            const hasAnyCreditQty = creditQtyKeys.some(k => parseInt(entry[k] || 0) > 0);
            if (!hasAnyCreditQty) {
                showAlert('creditAlert', 'Please enter at least one material quantity for Stock IN.', 'error');
                return;
            }
            if (!entry.date) {
                showAlert('creditAlert', 'Please select a date!', 'error');
                return;
            }

            if (editingCreditIndex !== -1) {
                data.credits[editingCreditIndex] = entry;
                editingCreditIndex = -1;
                showAlert('creditAlert', 'Entry updated!', 'success');
            } else {
                data.credits.push(entry);
                showAlert('creditAlert', 'Stock added successfully!', 'success');
            }

            updateCreditTable();
            updateCurrentStockDisplay();
            updateMaterialWiseSummary();
            updateIncomingHistory();
            updateArchiveView();
            saveToStorage();
            clearCreditForm();
        }

        function clearCreditForm() {
            ['creditA4210','creditA3210','credit13x17Film','creditA4180','creditFilm','creditFilm8x10Macron','creditFilmA3Macrone','creditFilmA4Macrom','creditA4130GSM','creditA4Film210GSM','creditBlack','creditYellow','creditCyan','creditMegenta','creditBlack500ML','creditGaryInk','creditCanonCyan','creditCanonMagenta','creditCanonYellow','creditCanonGray','creditRemark'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            // Reset date to today when clearing the form
            setTodayValue('creditDate');
            editingCreditIndex = -1;
        }

        function editCredit(idx) {
            const c = data.credits[idx];
            editingCreditIndex = idx;
            document.getElementById('creditDate').value = c.date;
            document.getElementById('creditMonth').value = c.month;
            document.getElementById('creditA4210').value = c.a4210;
            document.getElementById('creditA3210').value = c.a3210;
            document.getElementById('credit13x17Film').value = c.credit13x17Film;
            document.getElementById('creditA4180').value = c.a4180;
            document.getElementById('creditFilm').value = c.film;
            document.getElementById('creditFilm8x10Macron').value = c.film8x10Macron;
            document.getElementById('creditFilmA3Macrone').value = c.filmA3Macrone;
            document.getElementById('creditFilmA4Macrom').value = c.filmA4Macrom;
            document.getElementById('creditA4130GSM').value = c.a4130GSM;
            document.getElementById('creditA4Film210GSM').value = c.a4Film210GSM;
            document.getElementById('creditBlack').value = c.black;
            document.getElementById('creditYellow').value = c.yellow;
            document.getElementById('creditCyan').value = c.cyan;
            document.getElementById('creditMegenta').value = c.megenta;
            document.getElementById('creditBlack500ML').value = c.black500ml;
            document.getElementById('creditGaryInk').value = c.garyInk;
            document.getElementById('creditCanonCyan').value = c.canonCyan;
            document.getElementById('creditCanonMagenta').value = c.canonMagenta;
            document.getElementById('creditCanonYellow').value = c.canonYellow;
            document.getElementById('creditCanonGray').value = c.canonGray;
            document.getElementById('creditRemark').value = c.remark;
            document.getElementById('creditHistorySection').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function calculateRowTotal(c) {
            let total = 0;
            Object.keys(c).forEach(key => {
                if (key !== 'date' && key !== 'month' && key !== 'remark') {
                    total += parseInt(c[key] || 0);
                }
            });
            return total;
        }

        function updateCreditTable() {
            const tbody = document.getElementById('creditTableBody');
            tbody.innerHTML = '';
            let totals = {
                a4210: 0, a3210: 0, credit13x17Film: 0, a4180: 0, film: 0, film8x10Macron: 0, filmA3Macrone: 0, filmA4Macrom: 0, a4130GSM: 0, a4Film210GSM: 0,
                black: 0, yellow: 0, cyan: 0, megenta: 0, black500ml: 0, garyInk: 0, canonCyan: 0, canonMagenta: 0, canonYellow: 0, canonGray: 0
            };
            let grandTotal = 0;

            data.credits.forEach((c, idx) => {
                Object.keys(totals).forEach(key => {
                    totals[key] += parseInt(c[key] || 0);
                });
                const rowTotal = calculateRowTotal(c);
                grandTotal += rowTotal;

                tbody.innerHTML += `<tr>
                    <td>${c.date}</td><td>${c.month}</td>
                    <td>${c.a4210}</td><td>${c.a3210}</td><td>${c.credit13x17Film}</td><td>${c.a4180}</td><td>${c.film}</td>
                    <td>${c.film8x10Macron}</td><td>${c.filmA3Macrone}</td><td>${c.filmA4Macrom}</td>
                    <td>${c.a4130GSM}</td><td>${c.a4Film210GSM}</td>
                    <td>${c.black}</td><td>${c.yellow}</td><td>${c.cyan}</td><td>${c.megenta}</td>
                    <td>${c.black500ml}</td><td>${c.garyInk}</td>
                    <td>${c.canonCyan}</td><td>${c.canonMagenta}</td><td>${c.canonYellow}</td><td>${c.canonGray}</td>
                    <td class="total-column">${rowTotal}</td>
                    <td class="notes-column">${c.remark}</td>
                    <td>
                        <button class="btn-edit" onclick="editCredit(${idx})">Edit</button>
                        <button class="btn-delete" onclick="requestPasswordVerification('deleteCredit', ${idx})">Delete</button>
                    </td>
                </tr>`;
            });

            document.getElementById('totalCreditA4210').innerText = totals.a4210;
            document.getElementById('totalCreditA3210').innerText = totals.a3210;
            document.getElementById('totalCredit13x17Film').innerText = totals.credit13x17Film;
            document.getElementById('totalCreditA4180').innerText = totals.a4180;
            document.getElementById('totalCreditFilm').innerText = totals.film;
            document.getElementById('totalCreditFilm8x10Macron').innerText = totals.film8x10Macron;
            document.getElementById('totalCreditFilmA3Macrone').innerText = totals.filmA3Macrone;
            document.getElementById('totalCreditFilmA4Macrom').innerText = totals.filmA4Macrom;
            document.getElementById('totalCreditA4130GSM').innerText = totals.a4130GSM;
            document.getElementById('totalCreditA4Film210GSM').innerText = totals.a4Film210GSM;
            document.getElementById('totalCreditBlack').innerText = totals.black;
            document.getElementById('totalCreditYellow').innerText = totals.yellow;
            document.getElementById('totalCreditCyan').innerText = totals.cyan;
            document.getElementById('totalCreditMagenta').innerText = totals.megenta;
            document.getElementById('totalCredit500ML').innerText = totals.black500ml;
            document.getElementById('totalCreditGaryInk').innerText = totals.garyInk;
            document.getElementById('totalCreditCanonCyan').innerText = totals.canonCyan;
            document.getElementById('totalCreditCanonMagenta').innerText = totals.canonMagenta;
            document.getElementById('totalCreditCanonYellow').innerText = totals.canonYellow;
            document.getElementById('totalCreditCanonGray').innerText = totals.canonGray;
            document.getElementById('grandTotalCredit').innerText = grandTotal;
        }

        function filterStockTable() {
            const search = document.getElementById('stockSearchInput').value.toLowerCase();
            const rows = document.getElementById('creditTableBody').getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function filterStockTableAdvanced() {
            alert('üîç Live search activated! Real-time filter ho jaata hai!');
        }

        // DISPATCH FUNCTIONS
        function updateDispatchHospitalDropdown() {
            try {
                // Build HTML for options
                let html = '<option value="">-- Choose Hospital --</option>';
                if (!data || !data.hospitals) {
                    console.warn('No hospitals data available');
                } else if (data.hospitals.length > 0) {
                    data.hospitals.forEach((h, idx) => {
                        if (h && h.name) html += `<option value="${idx}">${h.name}</option>`;
                    });
                }

                // Populate all selects that use the dispatchHospital id (handles duplicated forms)
                const sels = Array.from(document.querySelectorAll('select[id="dispatchHospital"]'));
                if (sels.length === 0) {
                    // fallback: try single id
                    const single = document.getElementById('dispatchHospital');
                    if (single) single.innerHTML = html;
                } else {
                    sels.forEach(s => { s.innerHTML = html; });
                }

                console.log('Dropdown(s) updated for dispatch with options count:', (data && data.hospitals ? data.hospitals.length : 0));
            } catch (error) {
                console.error('Error updating dispatch dropdown:', error);
            }
        }

        function updateDispatchHospitalInfo() {
            try {
                // Try to find the currently active dispatch select (visible in active tab)
                let sel = document.querySelector('.tab-content.active select[id="dispatchHospital"]') || document.activeElement;
                if (!sel || sel.tagName !== 'SELECT') sel = document.getElementById('dispatchHospital');

                const idx = sel ? parseInt(sel.value) : NaN;

                // Find the location input associated with this select (prefer same form area)
                let locInput = null;
                if (sel) {
                    const container = sel.closest('.form-row') || sel.parentElement;
                    if (container) locInput = container.querySelector('input[id="dispatchLocation"]');
                }
                // fallback: update all location inputs with id dispatchLocation
                const allLocs = Array.from(document.querySelectorAll('input[id="dispatchLocation"]'));

                const locationValue = (!isNaN(idx) && data && data.hospitals && idx >= 0 && idx < data.hospitals.length) ? (data.hospitals[idx].location || '') : '';

                if (locInput) locInput.value = locationValue;
                // keep all in sync
                allLocs.forEach(l => { l.value = locationValue; });

                console.log('Location auto-filled for dispatch:', locationValue);
            } catch (error) {
                console.error('Error updating location:', error);
            }
        }

        function addDispatchEntry() {
    // prefer values from the active tab's form (handles duplicated forms)
    const activeContainer = document.querySelector('.tab-content.active') || document;
    const dateEl = (activeContainer.querySelector('input[id="dispatchDate"]') || document.getElementById('dispatchDate'));
    const sel = (activeContainer.querySelector('select[id="dispatchHospital"]') || document.getElementById('dispatchHospital'));
    const locEl = (activeContainer.querySelector('input[id="dispatchLocation"]') || document.getElementById('dispatchLocation'));

    const date = dateEl ? dateEl.value : '';
    const hospitalIdx = sel ? sel.value : '';
    const hospitalIdxNum = !isNaN(parseInt(hospitalIdx)) ? parseInt(hospitalIdx) : -1;
    const hospital = (hospitalIdx !== '' && data && data.hospitals && hospitalIdxNum >= 0)
        ? data.hospitals[hospitalIdxNum]?.name
        : '';
    const location = locEl ? locEl.value : '';

    // helper to get numeric value from the active form first, fallback to global element
    const getVal = (id) => {
        try {
            const el = (activeContainer !== document) ? activeContainer.querySelector('#' + id) : null;
            const target = el || document.getElementById(id);
            return parseInt(target && target.value ? target.value : 0) || 0;
        } catch (e) {
            return 0;
        }
    };

    const entry = {
        date, hospital, location,
        a4210: getVal('dispatchA4210'),
        a3210: getVal('dispatchA3210'),
        dispatch13x17Film: getVal('dispatch13x17Film'),
        a4180: getVal('dispatchA4180'),
        film: getVal('dispatchFilm'),
        film8x10Macron: getVal('dispatchFilm8x10Macron'),
        filmA3Macrone: getVal('dispatchFilmA3Macrone'),
        filmA4Macrom: getVal('dispatchFilmA4Macrom'),
        a4130GSM: getVal('dispatchA4130GSM'),
        a4Film210GSM: getVal('dispatchA4Film210GSM'),
        black: getVal('dispatchBlack'),
        yellow: getVal('dispatchYellow'),
        cyan: getVal('dispatchCyan'),
        megenta: getVal('dispatchMegenta'),
        black500ml: getVal('dispatchBlack500ML'),
        garyInk: getVal('dispatchGaryInk'),
        canonCyan: getVal('dispatchCanonCyan'),
        canonMagenta: getVal('dispatchCanonMagenta'),
        canonYellow: getVal('dispatchCanonYellow'),
        canonGray: getVal('dispatchCanonGray')
    };

    // 1Ô∏è‚É£ Validation: at least one material quantity must be > 0
    const dispatchQtyKeys = [
        'a4210','a3210','dispatch13x17Film','a4180','film','film8x10Macron',
        'filmA3Macrone','filmA4Macrom','a4130GSM','a4Film210GSM','black','yellow',
        'cyan','megenta','black500ml','garyInk','canonCyan','canonMagenta',
        'canonYellow','canonGray'
    ];
    const hasAnyDispatchQty = dispatchQtyKeys.some(k => parseInt(entry[k] || 0) > 0);
    if (!hasAnyDispatchQty) {
        showAlert('dispatchAlert', 'Please enter at least one material quantity for Dispatch OUT.', 'error');
        return;
    }

    // 2Ô∏è‚É£ Date & Hospital required
    if (!date || hospitalIdxNum < 0) {
        showAlert('dispatchAlert', 'Date & Hospital required!', 'error');
        return;
    }

    // 3Ô∏è‚É£ NEW: 0 / kam stock check ‚Äì yahi pe issue solve hoga
    const currentStock = calculateStock();   // total IN - OUT wala stock

    const stockCheckMap = [
        { stockKey: 'a4210',            dispatchKey: 'a4210',             label: 'A4-210 GSM' },
        { stockKey: 'a3210',            dispatchKey: 'a3210',             label: 'A3-210 GSM' },
        { stockKey: 'credit13x17Film',  dispatchKey: 'dispatch13x17Film', label: '13x17 Film' },
        { stockKey: 'a4180',            dispatchKey: 'a4180',             label: 'A4-180 GSM' },
        { stockKey: 'film',             dispatchKey: 'film',              label: '8x10 Film' },
        { stockKey: 'film8x10Macron',   dispatchKey: 'film8x10Macron',    label: '8x10 Macron' },
        { stockKey: 'filmA3Macrone',    dispatchKey: 'filmA3Macrone',     label: 'A3 Macrone' },
        { stockKey: 'filmA4Macrom',     dispatchKey: 'filmA4Macrom',      label: 'A4 Macrom' },
        { stockKey: 'a4130GSM',         dispatchKey: 'a4130GSM',          label: 'A4 130GSM' },
        { stockKey: 'a4Film210GSM',     dispatchKey: 'a4Film210GSM',      label: 'A4 Film 210GSM' },
        { stockKey: 'black',            dispatchKey: 'black',             label: 'Black Ink' },
        { stockKey: 'yellow',           dispatchKey: 'yellow',            label: 'Yellow Ink' },
        { stockKey: 'cyan',             dispatchKey: 'cyan',              label: 'Cyan Ink' },
        { stockKey: 'megenta',          dispatchKey: 'megenta',           label: 'Magenta Ink' },
        { stockKey: 'black500ml',       dispatchKey: 'black500ml',        label: '500ML Black' },
        { stockKey: 'garyInk',          dispatchKey: 'garyInk',           label: 'Gary Ink' },
        { stockKey: 'canonCyan',        dispatchKey: 'canonCyan',         label: 'Canon Cyan' },
        { stockKey: 'canonMagenta',     dispatchKey: 'canonMagenta',      label: 'Canon Magenta' },
        { stockKey: 'canonYellow',      dispatchKey: 'canonYellow',       label: 'Canon Yellow' },
        { stockKey: 'canonGray',        dispatchKey: 'canonGray',         label: 'Canon Gray' }
    ];

    for (const item of stockCheckMap) {
        const requested = parseInt(entry[item.dispatchKey] || 0);

        // sirf wahi item check karo jisme qty dali hai
        if (requested > 0) {
            const available = parseInt(currentStock[item.stockKey] || 0);

            // 0 ya negative stock ‚Äì bilkul allow nahi
            if (available <= 0) {
                showAlert(
                    'dispatchAlert',
                    `${item.label} ka stock 0 hai. Dispatch OUT nahi ho sakta.`,
                    'error'
                );
                return;
            }

            // agar user available se zyada dal raha hai to bhi rok do
            if (requested > available) {
                showAlert(
                    'dispatchAlert',
                    `${item.label} ka available stock sirf ${available} hai. Please quantity kam kijiye.`,
                    'error'
                );
                return;
            }
        }
    }

    // 4Ô∏è‚É£ save / update
    if (editingDispatchIndex !== -1) {
        data.dispatches[editingDispatchIndex] = entry;
        editingDispatchIndex = -1;
        showAlert('dispatchAlert', 'Entry updated!', 'success');
    } else {
        data.dispatches.push(entry);
        showAlert('dispatchAlert', 'Dispatch saved!', 'success');
        createDeliveryNoteFromDispatch(entry);
    }

    updateDispatchTable();
    updateCurrentStockDisplay();
    updateMaterialWiseSummary();
    updateOutgoingHistory();
    updateArchiveView();
    saveToStorage();
    clearDispatchForm();
}

        function clearDispatchForm() {
            ['dispatchA4210','dispatchA3210','dispatch13x17Film','dispatchA4180','dispatchFilm','dispatchFilm8x10Macron','dispatchFilmA3Macrone','dispatchFilmA4Macrom','dispatchA4130GSM','dispatchA4Film210GSM','dispatchBlack','dispatchYellow','dispatchCyan','dispatchMegenta','dispatchBlack500ML','dispatchGaryInk','dispatchCanonCyan','dispatchCanonMagenta','dispatchCanonYellow','dispatchCanonGray'].forEach(id => {
                // clear all matching elements (handles duplicate IDs across tabs/forms)
                const els = Array.from(document.querySelectorAll('#' + id));
                els.forEach(el => { try { el.value = ''; } catch(e){} });
            });
            // Reset date to today when clearing the form
            setTodayValue('dispatchDate');
            editingDispatchIndex = -1;
        }

        function editDispatch(idx) {
            const d = data.dispatches[idx];
            editingDispatchIndex = idx;
            document.getElementById('dispatchDate').value = d.date;
            document.getElementById('dispatchHospital').value = '';
            document.getElementById('dispatchLocation').value = d.location;
            document.getElementById('dispatchA4210').value = d.a4210;
            document.getElementById('dispatchA3210').value = d.a3210;
            document.getElementById('dispatch13x17Film').value = d.dispatch13x17Film;
            document.getElementById('dispatchA4180').value = d.a4180;
            document.getElementById('dispatchFilm').value = d.film;
            document.getElementById('dispatchFilm8x10Macron').value = d.film8x10Macron;
            document.getElementById('dispatchFilmA3Macrone').value = d.filmA3Macrone;
            document.getElementById('dispatchFilmA4Macrom').value = d.filmA4Macrom;
            document.getElementById('dispatchA4130GSM').value = d.a4130GSM;
            document.getElementById('dispatchA4Film210GSM').value = d.a4Film210GSM;
            document.getElementById('dispatchBlack').value = d.black;
            document.getElementById('dispatchYellow').value = d.yellow;
            document.getElementById('dispatchCyan').value = d.cyan;
            document.getElementById('dispatchMegenta').value = d.megenta;
            document.getElementById('dispatchBlack500ML').value = d.black500ml;
            document.getElementById('dispatchGaryInk').value = d.garyInk;
            document.getElementById('dispatchCanonCyan').value = d.canonCyan;
            document.getElementById('dispatchCanonMagenta').value = d.canonMagenta;
            document.getElementById('dispatchCanonYellow').value = d.canonYellow;
            document.getElementById('dispatchCanonGray').value = d.canonGray;
            document.getElementById('dispatchHistorySection').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function updateDispatchTable() {
            const tbody = document.getElementById('dispatchTableBody');
            tbody.innerHTML = '';
            let totals = {
                a4210: 0, a3210: 0, dispatch13x17Film: 0, a4180: 0, film: 0, film8x10Macron: 0, filmA3Macrone: 0, filmA4Macrom: 0, a4130GSM: 0, a4Film210GSM: 0,
                black: 0, yellow: 0, cyan: 0, megenta: 0, black500ml: 0, garyInk: 0, canonCyan: 0, canonMagenta: 0, canonYellow: 0, canonGray: 0
            };
            let grandTotal = 0;

            data.dispatches.forEach((d, idx) => {
                Object.keys(totals).forEach(key => {
                    totals[key] += parseInt(d[key] || 0);
                });
                const rowTotal = Object.keys(d).reduce((sum, key) => {
                    if (key !== 'date' && key !== 'hospital' && key !== 'location') {
                        return sum + parseInt(d[key] || 0);
                    }
                    return sum;
                }, 0);
                grandTotal += rowTotal;

                tbody.innerHTML += `<tr>
                    <td>${d.date}</td><td class="bold-text">${d.hospital}</td><td>${d.location}</td>
                    <td>${d.a4210}</td><td>${d.a3210}</td><td>${d.dispatch13x17Film}</td><td>${d.a4180}</td><td>${d.film}</td>
                    <td>${d.film8x10Macron}</td><td>${d.filmA3Macrone}</td><td>${d.filmA4Macrom}</td>
                    <td>${d.a4130GSM}</td><td>${d.a4Film210GSM}</td>
                    <td>${d.black}</td><td>${d.yellow}</td><td>${d.cyan}</td><td>${d.megenta}</td>
                    <td>${d.black500ml}</td><td>${d.garyInk}</td>
                    <td>${d.canonCyan}</td><td>${d.canonMagenta}</td><td>${d.canonYellow}</td><td>${d.canonGray}</td>
                    <td class="total-column">${rowTotal}</td>
                    <td>
                        <button class="btn-edit" onclick="editDispatch(${idx})">Edit</button>
                        <button class="btn-delete" onclick="requestPasswordVerification('deleteDispatch', ${idx})">Delete</button>
                    </td>
                </tr>`;
            });

            document.getElementById('totalDispatchA4210').innerText = totals.a4210;
            document.getElementById('totalDispatchA3210').innerText = totals.a3210;
            document.getElementById('totalDispatch13x17Film').innerText = totals.dispatch13x17Film;
            document.getElementById('totalDispatchA4180').innerText = totals.a4180;
            document.getElementById('totalDispatchFilm').innerText = totals.film;
            document.getElementById('totalDispatchFilm8x10Macron').innerText = totals.film8x10Macron;
            document.getElementById('totalDispatchFilmA3Macrone').innerText = totals.filmA3Macrone;
            document.getElementById('totalDispatchFilmA4Macrom').innerText = totals.filmA4Macrom;
            document.getElementById('totalDispatchA4130GSM').innerText = totals.a4130GSM;
            document.getElementById('totalDispatchA4Film210GSM').innerText = totals.a4Film210GSM;
            document.getElementById('totalDispatchBlack').innerText = totals.black;
            document.getElementById('totalDispatchYellow').innerText = totals.yellow;
            document.getElementById('totalDispatchCyan').innerText = totals.cyan;
            document.getElementById('totalDispatchMagenta').innerText = totals.megenta;
            document.getElementById('totalDispatchBlack500ML').innerText = totals.black500ml;
            document.getElementById('totalDispatchGaryInk').innerText = totals.garyInk;
            document.getElementById('totalDispatchCanonCyan').innerText = totals.canonCyan;
            document.getElementById('totalDispatchCanonMagenta').innerText = totals.canonMagenta;
            document.getElementById('totalDispatchCanonYellow').innerText = totals.canonYellow;
            document.getElementById('totalDispatchCanonGray').innerText = totals.canonGray;
            document.getElementById('grandTotalDispatch').innerText = grandTotal;
        }

        function filterDispatchTable() {
            const search = document.getElementById('dispatchSearchInput').value.toLowerCase();
            const rows = document.getElementById('dispatchTableBody').getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function filterDispatchTableAdvanced() {
            alert('üîç Live search activated! Real-time filter ho jaata hai!');
        }

        // CURRENT STOCK
        function calculateStock() {
            let stock = {
                a4210: 0, a3210: 0, credit13x17Film: 0, a4180: 0, film: 0, film8x10Macron: 0, filmA3Macrone: 0, filmA4Macrom: 0, a4130GSM: 0, a4Film210GSM: 0,
                black: 0, yellow: 0, cyan: 0, megenta: 0, black500ml: 0, garyInk: 0, canonCyan: 0, canonMagenta: 0, canonYellow: 0, canonGray: 0
            };

            data.credits.forEach(c => {
                Object.keys(stock).forEach(key => {
                    stock[key] += parseInt(c[key] || 0);
                });
            });

            data.dispatches.forEach(d => {
                Object.keys(stock).forEach(key => {
                    const dispatchKey = key === 'credit13x17Film' ? 'dispatch13x17Film' : key;
                    stock[key] -= parseInt(d[dispatchKey] || 0);
                });
            });

            return stock;
        }

        function updateCurrentStockDisplay() {
            const stock = calculateStock();
            const items = [
                { key: 'a4210', label: 'A4-210' },
                { key: 'a3210', label: 'A3-210' },
                { key: 'credit13x17Film', label: '13x17 Film' },
                { key: 'a4180', label: 'A4-180' },
                { key: 'film', label: '8x10 Film' },
                { key: 'film8x10Macron', label: '8x10 Macron' },
                { key: 'filmA3Macrone', label: 'A3 Macrone' },
                { key: 'filmA4Macrom', label: 'A4 Macrom' },
                { key: 'a4130GSM', label: 'A4 130GSM' },
                { key: 'a4Film210GSM', label: 'A4 210GSM' },
                { key: 'black', label: 'Black Ink' },
                { key: 'yellow', label: 'Yellow Ink' },
                { key: 'cyan', label: 'Cyan Ink' },
                { key: 'megenta', label: 'Magenta Ink' },
                { key: 'black500ml', label: '500ML Black' },
                { key: 'garyInk', label: 'Gary Ink' },
                { key: 'canonCyan', label: 'Canon Cyan' },
                { key: 'canonMagenta', label: 'Canon Magenta' },
                { key: 'canonYellow', label: 'Canon Yellow' },
                { key: 'canonGray', label: 'Canon Gray' }
            ];

            let html = '';
            items.forEach(item => {
                html += `<div class="stat-card"><div class="stat-number">${Math.max(0, stock[item.key])}</div><div class="stat-label">${item.label}</div></div>`;
            });
            document.getElementById('consumableStats').innerHTML = html;
        }

        function updateMaterialWiseSummary() {
            // Material definition with their database field names
            const materials = [
                { fieldName: 'a4210', label: 'A4-210 GSM', category: 'Paper' },
                { fieldName: 'a3210', label: 'A3-210 GSM', category: 'Paper' },
                { fieldName: 'credit13x17Film', label: '13x17 Film', category: 'Film', dispatchField: 'dispatch13x17Film' },
                { fieldName: 'a4180', label: 'A4-180 GSM', category: 'Paper' },
                { fieldName: 'film', label: '8x10 Film', category: 'Film' },
                { fieldName: 'film8x10Macron', label: '8x10 Macron Weight', category: 'Film' },
                { fieldName: 'filmA3Macrone', label: 'A3 Macrone Weight', category: 'Film' },
                { fieldName: 'filmA4Macrom', label: 'A4 Macrom Weight', category: 'Film' },
                { fieldName: 'a4130GSM', label: 'A4 130GSM', category: 'Paper' },
                { fieldName: 'a4Film210GSM', label: 'A4 Film 210GSM', category: 'Paper' },
                { fieldName: 'black', label: 'Black Ink', category: 'Ink' },
                { fieldName: 'yellow', label: 'Yellow Ink', category: 'Ink' },
                { fieldName: 'cyan', label: 'Cyan Ink', category: 'Ink' },
                { fieldName: 'megenta', label: 'Magenta Ink', category: 'Ink' },
                { fieldName: 'black500ml', label: '500ML Black', category: 'Ink' },
                { fieldName: 'garyInk', label: 'Gary Ink', category: 'Ink' },
                { fieldName: 'canonCyan', label: 'Canon Cyan', category: 'Canon Ink' },
                { fieldName: 'canonMagenta', label: 'Canon Magenta', category: 'Canon Ink' },
                { fieldName: 'canonYellow', label: 'Canon Yellow', category: 'Canon Ink' },
                { fieldName: 'canonGray', label: 'Canon Gray', category: 'Canon Ink' }
            ];

            let totalIn = 0, totalOut = 0, totalBalance = 0;
            let html = '';

            materials.forEach(material => {
                // Calculate Total IN from all credits
                let materialIn = 0;
                data.credits.forEach(credit => {
                    materialIn += parseInt(credit[material.fieldName] || 0);
                });

                // Calculate Total OUT from all dispatches
                let materialOut = 0;
                const dispatchField = material.dispatchField || material.fieldName;
                data.dispatches.forEach(dispatch => {
                    materialOut += parseInt(dispatch[dispatchField] || 0);
                });

                // Calculate balance
                const balance = materialIn - materialOut;

                // Accumulate totals
                totalIn += materialIn;
                totalOut += materialOut;
                totalBalance += balance;

                // Determine status color and icon
                let statusColor = '#14B8A6'; // success/green
                let statusIcon = '‚úÖ';
                if (balance === 0) {
                    statusColor = '#F97316'; // warning/orange
                    statusIcon = '‚ö†Ô∏è';
                } else if (balance < 0) {
                    statusColor = '#EF4444'; // danger/red
                    statusIcon = '‚ùå';
                } else if (balance < 5) {
                    statusColor = '#F97316'; // warning/orange
                    statusIcon = '‚ö†Ô∏è';
                }

                // Build table row
                html += `
                <tr style="border-bottom: 1px solid #E5E7EB; transition: background 0.2s ease;">
                    <td style="padding: 12px 16px; font-weight: 600; color: var(--dark);">${material.label}</td>
                    <td style="padding: 12px 16px; text-align: center; color: var(--success); font-weight: 600;">${materialIn}</td>
                    <td style="padding: 12px 16px; text-align: center; color: var(--danger); font-weight: 600;">${materialOut}</td>
                    <td style="padding: 12px 16px; text-align: center; font-weight: 700; font-size: 16px; color: ${statusColor};">${balance}</td>
                    <td style="padding: 12px 16px; text-align: center; font-size: 18px;">${statusIcon}</td>
                </tr>
                `;
            });

            // Populate table body
            document.getElementById('materialSummaryTableBody').innerHTML = html;

            // Update totals in footer
            document.getElementById('materialSummaryTotalIn').textContent = totalIn;
            document.getElementById('materialSummaryTotalOut').textContent = totalOut;
            document.getElementById('materialSummaryTotalBalance').textContent = totalBalance;
        }

        function updateIncomingHistory() {
            let html = '';
            
            // Iterate through each credit entry and show complete row with all materials
            data.credits.forEach((credit, idx) => {
                // Calculate row total
                const total = parseInt(credit.a4210 || 0) + parseInt(credit.a3210 || 0) + 
                             parseInt(credit.credit13x17Film || 0) + parseInt(credit.a4180 || 0) +
                             parseInt(credit.film || 0) + parseInt(credit.film8x10Macron || 0) +
                             parseInt(credit.filmA3Macrone || 0) + parseInt(credit.filmA4Macrom || 0) +
                             parseInt(credit.a4130GSM || 0) + parseInt(credit.a4Film210GSM || 0) +
                             parseInt(credit.black || 0) + parseInt(credit.yellow || 0) +
                             parseInt(credit.cyan || 0) + parseInt(credit.megenta || 0) +
                             parseInt(credit.black500ml || 0) + parseInt(credit.garyInk || 0) +
                             parseInt(credit.canonCyan || 0) + parseInt(credit.canonMagenta || 0) +
                             parseInt(credit.canonYellow || 0) + parseInt(credit.canonGray || 0);

                html += `
                <tr style="border-bottom: 1px solid #E5E7EB;">
                    <td style="padding: 12px 8px; white-space: nowrap; text-align: center;">${credit.date}</td>
                    <td style="padding: 12px 8px; white-space: nowrap; text-align: center;">${credit.month}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.a4210 || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.a3210 || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.credit13x17Film || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.a4180 || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.film || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.film8x10Macron || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.filmA3Macrone || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.filmA4Macrom || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.a4130GSM || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.a4Film210GSM || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.black || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.yellow || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.cyan || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.megenta || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.black500ml || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.garyInk || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.canonCyan || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.canonMagenta || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.canonYellow || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${credit.canonGray || 0}</td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--primary);">${total}</td>
                    <td style="padding: 12px 8px; color: #6B7280;">${credit.remark || '-'}</td>
                    <td style="padding: 12px 8px; text-align: center;">
                        <button class="btn-edit" style="padding: 6px 12px; font-size: 12px;" onclick="editCredit(${idx})">Edit</button>
                        <button class="btn-delete" style="padding: 6px 12px; font-size: 12px; margin-left:6px;" onclick="requestPasswordVerification('deleteCredit', ${idx})">Delete</button>
                    </td>
                </tr>
                `;
            });

            if (!html) {
                html = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #999;">No stock IN records yet</td></tr>';
            }

            document.getElementById('incomingHistoryBody').innerHTML = html;
        }

        function filterIncomingHistory() {
            const search = document.getElementById('incomingHistorySearch').value.toLowerCase();
            const rows = document.querySelectorAll('#incomingHistoryBody tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function filterIncomingHistoryAdvanced() {
            alert('üîç Live search activated! Real-time filter ho jaata hai!');
        }

        function updateOutgoingHistory() {
            let html = '';
            
            // Iterate through each dispatch entry and show complete row with all materials
            data.dispatches.forEach((dispatch, idx) => {
                // Calculate row total
                const total = parseInt(dispatch.a4210 || 0) + parseInt(dispatch.a3210 || 0) + 
                             parseInt(dispatch.dispatch13x17Film || 0) + parseInt(dispatch.a4180 || 0) +
                             parseInt(dispatch.film || 0) + parseInt(dispatch.film8x10Macron || 0) +
                             parseInt(dispatch.filmA3Macrone || 0) + parseInt(dispatch.filmA4Macrom || 0) +
                             parseInt(dispatch.a4130GSM || 0) + parseInt(dispatch.a4Film210GSM || 0) +
                             parseInt(dispatch.black || 0) + parseInt(dispatch.yellow || 0) +
                             parseInt(dispatch.cyan || 0) + parseInt(dispatch.megenta || 0) +
                             parseInt(dispatch.black500ml || 0) + parseInt(dispatch.garyInk || 0) +
                             parseInt(dispatch.canonCyan || 0) + parseInt(dispatch.canonMagenta || 0) +
                             parseInt(dispatch.canonYellow || 0) + parseInt(dispatch.canonGray || 0);

                html += `
                <tr style="border-bottom: 1px solid #E5E7EB;">
                    <td style="padding: 12px 8px; white-space: nowrap; text-align: center;">${dispatch.date}</td>
                    <td style="padding: 12px 8px; white-space: nowrap; text-align: center; font-weight: 600;">${dispatch.hospital}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.a4210 || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.a3210 || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.dispatch13x17Film || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.a4180 || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.film || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.film8x10Macron || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.filmA3Macrone || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.filmA4Macrom || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.a4130GSM || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.a4Film210GSM || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.black || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.yellow || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.cyan || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.megenta || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.black500ml || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.garyInk || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.canonCyan || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.canonMagenta || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.canonYellow || 0}</td>
                    <td style="padding: 12px 8px; text-align: center;">${dispatch.canonGray || 0}</td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 700; color: var(--primary);">${total}</td>
                    <td style="padding: 12px 8px; color: #6B7280;">${dispatch.location || '-'}</td>
                    <td style="padding: 12px 8px; text-align: center;">
                        <button class="btn-edit" style="padding: 6px 12px; font-size: 12px;" onclick="editDispatch(${idx})">Edit</button>
                        <button class="btn-delete" style="padding: 6px 12px; font-size: 12px; margin-left:6px;" onclick="requestPasswordVerification('deleteDispatch', ${idx})">Delete</button>
                    </td>
                </tr>
                `;
            });

            if (!html) {
                html = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #999;">No dispatch OUT records yet</td></tr>';
            }

            document.getElementById('outgoingHistoryBody').innerHTML = html;
        }

        // Note: Deletion must be confirmed via password modal. Use requestPasswordVerification('deleteCredit', index) or requestPasswordVerification('deleteDispatch', index).

        function filterOutgoingHistory() {
            const search = document.getElementById('outgoingHistorySearch').value.toLowerCase();
            const rows = document.querySelectorAll('#outgoingHistoryBody tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function filterOutgoingHistoryAdvanced() {
            alert('üîç Live search activated! Real-time filter ho jaata hai!');
        }

        function updateHospitalListDisplay() {
            let html = '';
            if (data.hospitals.length === 0) {
                html = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #999;">No hospitals registered yet</td></tr>';
            } else {
                data.hospitals.forEach(hospital => {
                    html += `
                    <tr style="border-bottom: 1px solid #E5E7EB;">
                        <td style="padding: 12px 16px; font-weight: 600;">${hospital.name}</td>
                        <td style="padding: 12px 16px; color: #6B7280;">${hospital.location || '-'}</td>
                        <td style="padding: 12px 16px; color: #6B7280;">${hospital.contact || '-'}</td>
                    </tr>
                    `;
                });
            }
            document.getElementById('hospitalListBody').innerHTML = html;
        }

        // PRINTER PARTS
        document.getElementById('partCreditType')?.addEventListener('change', function() {
            const customGroup = document.getElementById('customPartNameGroup');
            if (this.value === 'Other') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        });

        document.getElementById('partDispatchType')?.addEventListener('change', function() {
            const customGroup = document.getElementById('customPartDispatchGroup');
            if (this.value === 'Other') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        });

        function addPartCredit() {
            const date = document.getElementById('partCreditDate').value;
            const type = document.getElementById('partCreditType').value;
            let partName = type;
            const qty = document.getElementById('partCreditQty').value;

            if (type === 'Other') {
                partName = document.getElementById('partCreditCustomName').value;
                if (!partName) {
                    showAlert('partsAlert', 'Enter custom part name!', 'error');
                    return;
                }
            }

            if (!date || !partName || !qty) {
                showAlert('partsAlert', 'All fields required!', 'error');
                return;
            }

            data.partsLog.push({ date, type: 'IN', partName, qty, hospital: '' });
            updatePartsTable();
            updatePartsStockCards();
            saveToStorage();
            showAlert('partsAlert', 'Part added!', 'success');
            document.getElementById('partCreditDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('partCreditQty').value = '';
            document.getElementById('partCreditCustomName').value = '';
        }

        function updatePartDispatchHospitalDropdown() {
            const sel = document.getElementById('partDispatchHospital');
            sel.innerHTML = '<option value="">-- Choose Hospital --</option>';
            data.hospitals.forEach((h, idx) => {
                sel.innerHTML += `<option value="${idx}"><span class="bold-text">${h.name}</span></option>`;
            });
        }

        function updatePartDispatchForm() {
            const sel = document.getElementById('partDispatchHospital');
            const idx = parseInt(sel.value);
            if (isNaN(idx) || idx < 0 || idx >= data.hospitals.length) {
                document.getElementById('pdContact-span').textContent = '-';
                document.getElementById('pdMobile-span').textContent = '-';
                document.getElementById('pdPrinter-span').textContent = '-';
                document.getElementById('pdSerial-span').textContent = '-';
                return;
            }
            const h = data.hospitals[idx];
            document.getElementById('pdContact-span').innerHTML = `<span class="bold-text">${h.contact}</span>`;
            document.getElementById('pdMobile-span').innerText = h.mobile;
            document.getElementById('pdPrinter-span').innerHTML = `<span class="bold-text">${h.printer}</span>`;
            document.getElementById('pdSerial-span').innerText = h.serial;
        }

        function addPartDispatch() {
            const date = document.getElementById('partDispatchDate').value;
            const hospitalIdx = document.getElementById('partDispatchHospital').value;
            const hospital = hospitalIdx ? data.hospitals[hospitalIdx]?.name : '';
            const type = document.getElementById('partDispatchType').value;
            let partName = type;
            const qty = document.getElementById('partDispatchQty').value;

            if (type === 'Other') {
                partName = document.getElementById('partDispatchCustomName').value;
                if (!partName) {
                    showAlert('partsAlert', 'Enter custom part name!', 'error');
                    return;
                }
            }

            if (!date || !hospital || !partName || !qty) {
                showAlert('partsAlert', 'All fields required!', 'error');
                return;
            }

            data.partsLog.push({ date, type: 'OUT', partName, qty, hospital });
            updatePartsTable();
            updatePartsStockCards();
            showAlert('partsAlert', 'Part dispatched!', 'success');
            document.getElementById('partDispatchDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('partDispatchQty').value = '';
            document.getElementById('partDispatchCustomName').value = '';
        }

        function updatePartsStockCards() {
            const parts = {};
            data.partsLog.forEach(log => {
                if (!parts[log.partName]) parts[log.partName] = 0;
                if (log.type === 'IN') parts[log.partName] += parseInt(log.qty || 0);
                else parts[log.partName] -= parseInt(log.qty || 0);
            });

            let html = '';
            Object.keys(parts).forEach(partName => {
                html += `<div class="stat-card"><div class="stat-number">${Math.max(0, parts[partName])}</div><div class="stat-label"><span class="bold-text">${partName}</span></div></div>`;
            });
            document.getElementById('partsStockCards').innerHTML = html || '<p style="color: #999; padding: 20px;">No parts added yet</p>';
        }

        function updatePartsTable() {
            const tbody = document.getElementById('partsTableBody');
            tbody.innerHTML = '';
            data.partsLog.forEach((log, idx) => {
                tbody.innerHTML += `<tr>
                    <td>${log.date}</td>
                    <td><span style="color: ${log.type === 'IN' ? 'var(--success)' : 'var(--danger)'};"><strong>${log.type}</strong></span></td>
                    <td class="bold-text">${log.partName}</td>
                    <td>${log.qty}</td>
                    <td class="bold-text">${log.hospital}</td>
                    <td><button class="btn-delete" onclick="requestPasswordVerification('deletePartLog', ${idx})">Delete</button></td>
                </tr>`;
            });
        }

        // HOSPITAL FUNCTIONS
        function addHospital() {
            const name = document.getElementById('hospitalName').value.trim();
            const location = document.getElementById('hospitalLocation').value.trim();
            const contact = document.getElementById('hospitalContact').value.trim();
            const mobile = document.getElementById('hospitalMobile').value.trim();
            const printer = document.getElementById('hospitalPrinterName').value.trim();
            const serial = document.getElementById('hospitalPrinterSerial').value.trim();
            const installDate = document.getElementById('hospitalInstallDate').value;
            const address = document.getElementById('hospitalAddress').value.trim();
            const pincode = (document.getElementById('hospitalPincode') ? document.getElementById('hospitalPincode').value.trim() : '');

            // collect printers from printersContainer rows
            const printers = [];
            const container = document.getElementById('printersContainer');
            if (container) {
                const rows = container.querySelectorAll('.printer-row');
                rows.forEach(r => {
                    const m = (r.querySelector('.printer-model') && r.querySelector('.printer-model').value.trim()) || '';
                    const s = (r.querySelector('.printer-serial') && r.querySelector('.printer-serial').value.trim()) || '';
                    if (m || s) printers.push({ printer: m, serial: s });
                });
            }

            // require basic fields and at least one printer
            if (!name || !location || !contact || !mobile || !installDate) {
                showAlert('hospitalAlert', 'All required fields must be filled!', 'error');
                return;
            }
            if (printers.length === 0 && (!printer || !serial)) {
                showAlert('hospitalAlert', 'Please add at least one printer for this hospital.', 'error');
                return;
            }

            // If older single-printer fields are used, include them
            if (printers.length === 0 && printer && serial) {
                printers.push({ printer: printer, serial: serial });
            }

            const hospital = { id: data.nextHospitalId++ , name, location, city: location, contact, mobile, printer: (printers[0] ? printers[0].printer : ''), serial: (printers[0] ? printers[0].serial : ''), installDate, address, pincode: pincode || '', printers: printers };
            if (currentHospitalEditIndex >= 0) {
    // update old
    data.hospitals[currentHospitalEditIndex] = hospital;
} else {
    // add new
    data.hospitals.push(hospital);
}

            updateDispatchHospitalDropdown();
            updatePartDispatchHospitalDropdown();
            updateHospitalTable();
            updateCounterHospitalDropdown();
            saveToStorage();
            showAlert('hospitalAlert', 'Hospital added!', 'success');
            clearHospitalForm();
        }

        function clearHospitalForm() {
            ['hospitalName', 'hospitalLocation', 'hospitalContact', 'hospitalMobile', 'hospitalPrinterName', 'hospitalPrinterSerial', 'hospitalInstallDate', 'hospitalAddress', 'hospitalPincode'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            // clear printers container and add one empty row
            const container = document.getElementById('printersContainer');
            if (container) {
                container.innerHTML = '';
                addPrinterRow();
            }
        }

        function updateHospitalTable() {
    const tbody = document.getElementById('hospitalTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    data.hospitals.forEach((h, idx) => {
        // printers array (old + new data compatible)
        const printers = Array.isArray(h.printers)
            ? h.printers
            : (h.printer ? [{ printer: h.printer || '', serial: h.serial || '' }] : []);

        const totalPrinters = printers.length;

        // default values
        let printerName  = '-';
        let printerSerial = '-';

        // sirf FIRST printer table me dikhayenge
        if (totalPrinters > 0) {
            const p = printers[0] || {};
            printerName  = p.printer || p.model || '-';
            printerSerial = p.serial || p.serialNo || '-';
        }
                // üëÅÔ∏è button sirf jab 1 se zyada printers hon
        let viewBtnHtml = '';
        if (totalPrinters > 1) {
            viewBtnHtml = `
                <button class="btn btn-secondary btn-icon"
                        onclick="showPrintersModal(${idx})"
                        title="View all printers">
                    üëÅÔ∏è
                </button>
            `;
        }

        tbody.innerHTML += `
            <tr>
                <td class="bold-text">${escapeHtml(h.name || '-')}</td>
                <td>${escapeHtml(h.address || '-')}</td>
                <td>${escapeHtml(h.location || h.city || '-')}</td>
                <td>${escapeHtml(h.pincode || '-')}</td>
                <td style="text-align:center; font-weight:700;">${totalPrinters}</td>
                <td> ${escapeHtml(printerName)} ${viewBtnHtml}</td>
                <td>${escapeHtml(printerSerial)}</td>
                <td>
                    <button class="btn-edit" onclick="editHospital(${idx})">Edit</button>
                    <button class="btn-delete" onclick="requestPasswordVerification('deleteHospital', ${idx})">Delete</button>
                </td>
            </tr>
        `;
    });
}

        
        // ==================== Excel Import (Hospitals) ====================
        // Temporary buffer to hold parsed rows until user clicks ADD ALL
        window.__hospitalImportBuffer = null;

        function handleHospitalImport(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const dataArr = new Uint8Array(evt.target.result);
                    const wb = XLSX.read(dataArr, { type: 'array' });
                    const firstSheetName = wb.SheetNames[0];
                    const sheet = wb.Sheets[firstSheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    // store rows in a global buffer; user must click ADD ALL to commit
                    window.__hospitalImportBuffer = rows;
                    // enable ADD ALL button and show confirmation
                    const addBtn = document.getElementById('hospitalAddAllBtn');
                    if (addBtn) {
                        addBtn.style.display = 'inline-block';
                        addBtn.disabled = false;
                    }
                    showAlert('hospitalAlert', 'File uploaded successfully. Click ADD ALL to import.', 'success');
                } catch (err) {
                    console.error('Import error', err);
                    showAlert('hospitalAlert', 'Failed to parse file. Make sure it is a valid .xlsx or .csv file.', 'error');
                    window.__hospitalImportBuffer = null;
                }
            };

            // read as array buffer to support xlsx and csv via SheetJS
            reader.readAsArrayBuffer(file);
            // clear input value to allow re-selecting same file later
            e.target.value = '';
        }

        function importHospitalsFromRows(rows) {
            if (!Array.isArray(rows) || rows.length === 0) {
                return { addedCount: 0, addedPrinterCount: 0 };
            }

            // helper to find a header key by exact names first, then contains
            function findHeaderKey(rowKeys, candidates) {
                const normalize = s => String(s || '').toLowerCase().replace(/\s+/g, '');
                const candNorm = candidates.map(c => normalize(c));
                // exact (after normalizing)
                for (const k of rowKeys) {
                    const nk = normalize(k);
                    if (candNorm.includes(nk)) return k;
                }
                // fallback: contains match
                for (const k of rowKeys) {
                    const nk = normalize(k);
                    for (const c of candNorm) {
                        if (nk.includes(c) || c.includes(nk)) return k;
                    }
                }
                return null;
            }

            const rowKeys = Object.keys(rows[0] || {});

            // mapping priorities per user request (exact expected columns)
            const nameKey = findHeaderKey(rowKeys, ['Hospital Name', 'Hospital', 'Name']);
            const addressKey = findHeaderKey(rowKeys, ['Address', 'Full Address']);
            const cityKey = findHeaderKey(rowKeys, ['City', 'Location / City', 'Location']);
            const pincodeKey = findHeaderKey(rowKeys, ['Pincode', 'Pin', 'Postal']);
            const printerModelKey = findHeaderKey(rowKeys, ['Printer Model', 'Printer']);
            const serialKey = findHeaderKey(rowKeys, ['Serial No', 'Serial', 'Printer Serial No', 'Printer Serial']);

            // If hospital name key not found, abort
            if (!nameKey) {
                alert('Could not find required column "Hospital Name" in the file. Please ensure the column exists.');
                return;
            }

            // Build groups by hospitalName + city + pincode
            const groups = {};
            rows.forEach(r => {
                const hospitalName = String(r[nameKey] || '').trim();
                if (!hospitalName) return; // skip
                const address = String(addressKey ? r[addressKey] || '' : '').trim();
                const cityVal = String(cityKey ? r[cityKey] || '' : '').trim();
                const pincode = String(pincodeKey ? r[pincodeKey] || '' : '').trim();
                const printerModel = String(printerModelKey ? r[printerModelKey] || '' : '').trim();
                const printerSerial = String(serialKey ? r[serialKey] || '' : '').trim();

                const key = (hospitalName || '').toLowerCase() + '||' + (cityVal || '').toLowerCase() + '||' + (pincode || '').toLowerCase();
                if (!groups[key]) groups[key] = { name: hospitalName, address: address, city: cityVal, location: cityVal, pincode: pincode, printers: [] };
                if (printerModel || printerSerial) {
                    groups[key].printers.push({ printer: printerModel || '', serial: printerSerial || '' });
                }
            });

            // Load existing hospital master from localStorage (user-specified key)
            let hospitalList = [];
            try {
                const raw = localStorage.getItem('msHospitalMaster');
                hospitalList = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(hospitalList)) hospitalList = [];
            } catch (err) {
                hospitalList = [];
            }

            // Merge groups into hospitalList, avoiding duplicates (name+city+pincode)
            let addedCount = 0;
            let addedPrinterCount = 0;
            Object.keys(groups).forEach(k => {
                const g = groups[k];
                // match existing hospital by name + city (or location) + pincode
                const existingIdx = hospitalList.findIndex(h => {
                    const hName = String(h.name||'').toLowerCase().trim();
                    const hCity = String(h.city || h.location || '').toLowerCase().trim();
                    const gName = String(g.name||'').toLowerCase().trim();
                    const gCity = String(g.city || g.location || '').toLowerCase().trim();
                    const hPin = String(h.pincode||'').toLowerCase().trim();
                    const gPin = String(g.pincode||'').toLowerCase().trim();
                    return hName === gName && hCity === gCity && hPin === gPin;
                });
                if (existingIdx >= 0) {
                    // merge printers into existing
                    const exist = hospitalList[existingIdx];
                    if (!Array.isArray(exist.printers)) {
                        exist.printers = exist.printer ? [{ printer: exist.printer || '', serial: exist.serial || '' }] : [];
                    }
                    g.printers.forEach(p => {
                        const dup = exist.printers.find(ep => (ep.serial||'').trim() === (p.serial||'').trim() && (ep.printer||'').trim() === (p.printer||'').trim());
                        if (!dup) {
                            exist.printers.push(p);
                            addedPrinterCount++;
                        }
                    });
                    // keep address/pincode if empty
                    exist.address = exist.address || g.address;
                    exist.pincode = exist.pincode || g.pincode;
                    // ensure city and location fields exist
                    if (!exist.city) exist.city = exist.location || g.city || g.location || '';
                    if (!exist.location) exist.location = exist.city || g.location || g.city || '';
                } else {
                    const newHosp = {
                        name: g.name || '',
                        address: g.address || '',
                        city: g.city || g.location || '',
                        location: g.location || g.city || '',
                        pincode: g.pincode || '',
                        contact: '',
                        mobile: '',
                        installDate: '',
                        printers: Array.isArray(g.printers) ? g.printers.slice() : []
                    };
                    // For backward compatibility, set first printer fields
                    if (newHosp.printers.length) {
                        newHosp.printer = newHosp.printers[0].printer || '';
                        newHosp.serial = newHosp.printers[0].serial || '';
                        addedPrinterCount += newHosp.printers.length;
                    } else {
                        newHosp.printer = '';
                        newHosp.serial = '';
                    }
                    hospitalList.push(newHosp);
                    addedCount++;
                }
            });

            // Save into the exact key the user requested
            try {
                localStorage.setItem('msHospitalMaster', JSON.stringify(hospitalList));
            } catch (err) {
                console.error('Failed to save hospital master', err);
                alert('Failed to save imported hospitals to localStorage. See console for details.');
                return;
            }

            // Save into the exact key the user requested
            try {
                localStorage.setItem('msHospitalMaster', JSON.stringify(hospitalList));
            } catch (err) {
                console.error('Failed to save hospital master', err);
                showAlert('hospitalAlert', 'Failed to save imported hospitals to localStorage. See console for details.', 'error');
                return { addedCount, addedPrinterCount };
            }

            // Refresh hospital UI using requested project function names
            try {
                if (typeof loadHospitalMaster === 'function') loadHospitalMaster();
                if (typeof renderHospitalList === 'function') renderHospitalList();
                // backward compatibility: other updater names
                if (typeof loadHospitalList === 'function') loadHospitalList();
                if (typeof updateHospitalListTable === 'function') updateHospitalListTable();
                if (typeof updateHospitalTable === 'function') updateHospitalTable();
            } catch (err) {
                console.warn('Could not call one or more hospital refresh functions', err);
            }

            return { addedCount, addedPrinterCount };
        }

        // Called when user clicks ADD ALL after uploading a file
        function performAddAllHospitals() {
            const btn = document.getElementById('hospitalAddAllBtn');
            if (btn) {
                btn.disabled = true;
            }
            const rows = window.__hospitalImportBuffer;
            if (!Array.isArray(rows) || rows.length === 0) {
                showAlert('hospitalAlert', 'No valid hospital data found in the Excel file.', 'error');
                if (btn) btn.style.display = 'none';
                window.__hospitalImportBuffer = null;
                return;
            }

            const result = importHospitalsFromRows(rows) || { addedCount: 0, addedPrinterCount: 0 };
            if ((result.addedCount || 0) > 0 || (result.addedPrinterCount || 0) > 0) {
                showAlert('hospitalAlert', `Import Completed: ${result.addedCount} hospitals added, ${result.addedPrinterCount} printers added.`, 'success');
            } else {
                showAlert('hospitalAlert', 'No valid hospital data found in the Excel file.', 'error');
            }

            // cleanup buffer and hide button
            window.__hospitalImportBuffer = null;
            if (btn) {
                btn.style.display = 'none';
                btn.disabled = false;
            }
        }


        function editHospital(idx) {
            currentHospitalEditIndex = idx;
            const h = data.hospitals[idx];
            document.getElementById('hospitalName').value = h.name;
            document.getElementById('hospitalLocation').value = h.location;
            document.getElementById('hospitalContact').value = h.contact;
            document.getElementById('hospitalMobile').value = h.mobile;
            document.getElementById('hospitalPrinterName').value = h.printer || '';
            document.getElementById('hospitalPrinterSerial').value = h.serial || '';
            document.getElementById('hospitalInstallDate').value = h.installDate || '';
            document.getElementById('hospitalAddress').value = h.address || '';
            if (document.getElementById('hospitalPincode')) document.getElementById('hospitalPincode').value = h.pincode || '';
            // populate printers container
            const container = document.getElementById('printersContainer');
            if (container) {
                container.innerHTML = '';
                const printers = Array.isArray(h.printers) ? h.printers : (h.printer ? [{ printer: h.printer || '', serial: h.serial || '' }] : []);
                if (printers.length) {
                    printers.forEach(p => addPrinterRow(p.printer || '', p.serial || ''));
                } else {
                    addPrinterRow();
                }
            }
        }

        function filterHospitalTable() {
            const search = document.getElementById('hospitalSearch').value.toLowerCase();
            const rows = document.getElementById('hospitalTableBody').getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function filterHospitalTableAdvanced() {
            alert('üîç Live search activated! Real-time filter ho jaata hai!');
        }

        // Show printers modal for a hospital
        function showPrintersModal(idx) {
            const h = data.hospitals[idx];
            if (!h) return;
            const printers = Array.isArray(h.printers) ? h.printers : (h.printer ? [{ printer: h.printer || '', serial: h.serial || '' }] : []);
            const body = document.getElementById('printersModalBody');
            body.innerHTML = '';
            if (!printers.length) {
                body.innerHTML = '<p>No printers available</p>';
            } else {
                let html = '<ul style="padding-left:18px;">';
                printers.forEach(p => {
                    html += `<li><strong>${p.printer || '-'}</strong> ‚Äî ${p.serial || '-'}</li>`;
                });
                html += '</ul>';
                body.innerHTML = html;
            }
            document.getElementById('printersModal').style.display = 'flex';
        }

        function closePrintersModal() {
            document.getElementById('printersModal').style.display = 'none';
        }

        // Printer rows management for Add/Edit Hospital form
        function addPrinterRow(model = '', serial = '') {
            const container = document.getElementById('printersContainer');
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'printer-row';
            row.style.display = 'flex';
            row.style.gap = '8px';
            row.style.marginTop = '6px';
            row.innerHTML = `
                <input class="printer-model" placeholder="Model No." style="flex:1; padding:8px; border-radius:6px; border:1px solid #D1D5DB;" value="${escapeHtml(model)}">
                <input class="printer-serial" placeholder="Serial No." style="width:180px; padding:8px; border-radius:6px; border:1px solid #D1D5DB;" value="${escapeHtml(serial)}">
                <button type="button" class="btn btn-danger" style="padding:6px 8px;" onclick="this.parentNode.remove();">‚ùå</button>
            `;
            container.appendChild(row);
        }

        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // ARCHIVE VIEW FUNCTIONS
        function initializeArchiveView() {
            updateArchiveView();
            saveToStorage();
        }

        function updateArchiveView() {
            let currentCreditCount = 0, currentDispatchCount = 0, currentTotalIn = 0, currentTotalOut = 0;
            
            data.credits.forEach(c => {
                currentCreditCount++;
                Object.keys(c).forEach(key => {
                    if (key !== 'month' && key !== 'date' && key !== 'remark')
                        currentTotalIn += parseInt(c[key] || 0);
                });
            });

            data.dispatches.forEach(d => {
                currentDispatchCount++;
                Object.keys(d).forEach(key => {
                    if (key !== 'date' && key !== 'hospital' && key !== 'location')
                        currentTotalOut += parseInt(d[key] || 0);
                });
            });

            document.getElementById('currentCreditCount').innerText = currentCreditCount;
            document.getElementById('currentDispatchCount').innerText = currentDispatchCount;
            document.getElementById('currentTotalIn').innerText = currentTotalIn;
            document.getElementById('currentTotalOut').innerText = currentTotalOut;

            let creditHtml = '';
            data.credits.forEach(c => {
                const rowTotal = calculateRowTotal(c);
                creditHtml += `
<tr>
    <td>${c.date}</td>
    <td>${c.month}</td>

    <td>${c.a4210}</td>
    <td>${c.a3210}</td>
    <td>${c.credit13x17Film}</td>
    <td>${c.a4180}</td>

    <td>${c.film}</td>
    <td>${c.film8x10Macron}</td>
    <td>${c.filmA3Macrone}</td>
    <td>${c.filmA4Macrom}</td>

    <td>${c.a4130GSM}</td>
    <td>${c.a4Film210GSM}</td>

    <td>${c.black}</td>
    <td>${c.yellow}</td>
    <td>${c.cyan}</td>
    <td>${c.megenta}</td>

    <td>${c.black500ml}</td>
    <td>${c.garyInk}</td>

    <td>${c.canonCyan}</td>
    <td>${c.canonMagenta}</td>
    <td>${c.canonYellow}</td>
    <td>${c.canonGray}</td>

    <td class="total-column">${calculateRowTotal(c)}</td>
    <td class="notes-column">${c.remark}</td>
</tr>
`;

            });
            document.getElementById('currentCreditStockTableBody').innerHTML = creditHtml || '<tr><td colspan="12" style="text-align:center; color:#999;">No data</td></tr>';

            const hospitalDispatch = {};
            data.dispatches.forEach(d => {
                if (!hospitalDispatch[d.hospital]) {
                    hospitalDispatch[d.hospital] = {
                        location: d.location,
                        a4210: 0, a3210: 0, dispatch13x17Film: 0, a4180: 0, film: 0, film8x10Macron: 0, filmA3Macrone: 0, filmA4Macrom: 0, a4130GSM: 0, a4Film210GSM: 0, black: 0, yellow: 0, cyan: 0, megenta: 0, black500ml: 0, garyInk: 0, canonCyan: 0, canonMagenta: 0, canonYellow: 0, canonGray: 0
                    };
                }
                hospitalDispatch[d.hospital].a4210 += parseInt(d.a4210 || 0);
                hospitalDispatch[d.hospital].a3210 += parseInt(d.a3210 || 0);
                hospitalDispatch[d.hospital].dispatch13x17Film += parseInt(d.dispatch13x17Film || 0);
                hospitalDispatch[d.hospital].a4180 += parseInt(d.a4180 || 0);
                hospitalDispatch[d.hospital].film += parseInt(d.film || 0);
                hospitalDispatch[d.hospital].film8x10Macron += parseInt(d.film8x10Macron || 0);
                hospitalDispatch[d.hospital].filmA3Macrone += parseInt(d.filmA3Macrone || 0);
                hospitalDispatch[d.hospital].filmA4Macrom += parseInt(d.filmA4Macrom || 0);
                hospitalDispatch[d.hospital].a4130GSM += parseInt(d.a4130GSM || 0);
                hospitalDispatch[d.hospital].a4Film210GSM += parseInt(d.a4Film210GSM || 0);
                hospitalDispatch[d.hospital].black += parseInt(d.black || 0);
                hospitalDispatch[d.hospital].yellow += parseInt(d.yellow || 0);
                hospitalDispatch[d.hospital].cyan += parseInt(d.cyan || 0);
                hospitalDispatch[d.hospital].megenta += parseInt(d.megenta || 0);
                hospitalDispatch[d.hospital].black500ml += parseInt(d.black500ml || 0);
                hospitalDispatch[d.hospital].garyInk += parseInt(d.garyInk || 0);
                hospitalDispatch[d.hospital].canonCyan += parseInt(d.canonCyan || 0);
                hospitalDispatch[d.hospital].canonMagenta += parseInt(d.canonMagenta || 0);
                hospitalDispatch[d.hospital].canonYellow += parseInt(d.canonYellow || 0);
                hospitalDispatch[d.hospital].canonGray += parseInt(d.canonGray || 0);
            });

            let dispatchHtml = '';
            Object.keys(hospitalDispatch).forEach(hospital => {
                const h = hospitalDispatch[hospital];
                const total = h.a4210 + h.a3210 + h.dispatch13x17Film + h.a4180 + h.film + h.film8x10Macron + h.filmA3Macrone + h.filmA4Macrom + h.a4130GSM + h.a4Film210GSM + h.black + h.yellow + h.cyan + h.megenta + h.black500ml + h.garyInk + h.canonCyan + h.canonMagenta + h.canonYellow + h.canonGray;
                dispatchHtml += `<tr><td class="bold-text">${hospital}</td><td>${h.location}</td><td>${h.a4210}</td><td>${h.a3210}</td><td>${h.dispatch13x17Film}</td><td>${h.a4180}</td><td>${h.film}</td><td>${h.film8x10Macron}</td><td>${h.filmA3Macrone}</td><td>${h.filmA4Macrom}</td><td>${h.a4130GSM}</td><td>${h.a4Film210GSM}</td><td>${h.black}</td><td>${h.yellow}</td><td>${h.cyan}</td><td>${h.megenta}</td><td>${h.black500ml}</td><td>${h.garyInk}</td><td>${h.canonCyan}</td><td>${h.canonMagenta}</td><td>${h.canonYellow}</td><td>${h.canonGray}</td><td class="total-column">${total}</td></tr>`;
            });
            document.getElementById('currentDispatchTableBody').innerHTML = dispatchHtml || '<tr><td colspan="23" style="text-align:center; color:#999;">No data</td></tr>';

            const selector = document.getElementById('archiveMonthSelector');
            selector.innerHTML = '<option value="">-- Select Month --</option>';
            data.archived.forEach((arch, idx) => {
                selector.innerHTML += `<option value="${idx}">${arch.month}</option>`;
            });
        }

        function archiveCurrentMonth() {
            if (data.credits.length === 0 && data.dispatches.length === 0) {
                showAlert('dispatchAlert', 'No data to archive!', 'error');
                return;
            }

            const month = data.currentMonth;
            const archived = {
                month: month,
                credits: JSON.parse(JSON.stringify(data.credits)),
                dispatches: JSON.parse(JSON.stringify(data.dispatches))
            };

            data.archived.push(archived);
            data.credits = [];
            data.dispatches = [];

            updateCreditTable();
            updateDispatchTable();
            updateCurrentStockDisplay();
            updateMaterialWiseSummary();
            updateIncomingHistory();
            updateOutgoingHistory();
            updateArchiveView();
            saveToStorage();
            showAlert('dispatchAlert', `Month ${month} archived successfully! Current month cleared.`, 'success');
        }

        function showArchivedMonthData() {
            const idx = parseInt(document.getElementById('archiveMonthSelector').value);
            if (isNaN(idx) || idx < 0 || idx >= data.archived.length) {
                document.getElementById('archiveDetailBox').classList.remove('show');
                currentArchiveMonth = -1;
                return;
            }

            currentArchiveMonth = idx;
            const arch = data.archived[idx];
            document.getElementById('archiveMonthLabel').innerText = arch.month;

            let creditCount = arch.credits.length;
            let dispatchCount = arch.dispatches.length;
            let totalIn = 0, totalOut = 0;

            arch.credits.forEach(c => {
                Object.keys(c).forEach(key => {
                    if (key !== 'month' && key !== 'date' && key !== 'remark')
                        totalIn += parseInt(c[key] || 0);
                });
            });

            arch.dispatches.forEach(d => {
                Object.keys(d).forEach(key => {
                    if (key !== 'date' && key !== 'hospital' && key !== 'location')
                        totalOut += parseInt(d[key] || 0);
                });
            });

            document.getElementById('archiveCreditCount').innerText = creditCount;
            document.getElementById('archiveDispatchCount').innerText = dispatchCount;
            document.getElementById('archiveTotalIn').innerText = totalIn;
            document.getElementById('archiveTotalOut').innerText = totalOut;

            // MATERIAL SUMMARY - HORIZONTAL SCROLL
            let materialSummaryHtml = '';
            materialFields.forEach(field => {
                let inQty = 0, outQty = 0;
                arch.credits.forEach(c => {
                    inQty += parseInt(c[field.key] || 0);
                });
                arch.dispatches.forEach(d => {
                    const dispatchKey = field.key === 'credit13x17Film' ? 'dispatch13x17Film' : field.key;
                    outQty += parseInt(d[dispatchKey] || 0);
                });
                const balance = inQty - outQty;
                materialSummaryHtml += `
                    <div class="material-card">
                        <div class="material-card-name">${field.label}</div>
                        <div class="material-card-row">
                            <div class="material-card-item material-card-in">
                                <div>${inQty}</div>
                                <div class="material-card-label">IN</div>
                            </div>
                            <div class="material-card-item material-card-out">
                                <div>${outQty}</div>
                                <div class="material-card-label">OUT</div>
                            </div>
                            <div class="material-card-item material-card-balance">
                                <div>${balance}</div>
                                <div class="material-card-label">BAL</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('archiveMaterialSummary').innerHTML = materialSummaryHtml;

            // Archive credit table
            let creditHtml = '';
            arch.credits.forEach(c => {
                const rowTotal = calculateRowTotal(c);
                creditHtml += `
<tr>
    <td>${c.date}</td>
    <td>${c.month}</td>

    <td>${c.a4210}</td>
    <td>${c.a3210}</td>
    <td>${c.credit13x17Film}</td>
    <td>${c.a4180}</td>

    <td>${c.film}</td>
    <td>${c.film8x10Macron}</td>
    <td>${c.filmA3Macrone}</td>
    <td>${c.filmA4Macrom}</td>

    <td>${c.a4130GSM}</td>
    <td>${c.a4Film210GSM}</td>

    <td>${c.black}</td>
    <td>${c.yellow}</td>
    <td>${c.cyan}</td>
    <td>${c.megenta}</td>

    <td>${c.black500ml}</td>
    <td>${c.garyInk}</td>

    <td>${c.canonCyan}</td>
    <td>${c.canonMagenta}</td>
    <td>${c.canonYellow}</td>
    <td>${c.canonGray}</td>

    <td class="total-column">${calculateRowTotal(c)}</td>
    <td class="notes-column">${c.remark}</td>
</tr>
`;

            });
            document.getElementById('archiveCreditStockTableBody').innerHTML = creditHtml || '<tr><td colspan="12" style="text-align:center; color:#999;">No data</td></tr>';

            // Archive dispatch table
            const hospitalDispatch = {};
            arch.dispatches.forEach(d => {
                if (!hospitalDispatch[d.hospital]) {
                    hospitalDispatch[d.hospital] = {
                        location: d.location,
                        a4210: 0, a3210: 0, dispatch13x17Film: 0, a4180: 0, film: 0, film8x10Macron: 0, filmA3Macrone: 0, filmA4Macrom: 0, a4130GSM: 0, a4Film210GSM: 0, black: 0, yellow: 0, cyan: 0, megenta: 0, black500ml: 0, garyInk: 0, canonCyan: 0, canonMagenta: 0, canonYellow: 0, canonGray: 0
                    };
                }
                hospitalDispatch[d.hospital].a4210 += parseInt(d.a4210 || 0);
                hospitalDispatch[d.hospital].a3210 += parseInt(d.a3210 || 0);
                hospitalDispatch[d.hospital].dispatch13x17Film += parseInt(d.dispatch13x17Film || 0);
                hospitalDispatch[d.hospital].a4180 += parseInt(d.a4180 || 0);
                hospitalDispatch[d.hospital].film += parseInt(d.film || 0);
                hospitalDispatch[d.hospital].film8x10Macron += parseInt(d.film8x10Macron || 0);
                hospitalDispatch[d.hospital].filmA3Macrone += parseInt(d.filmA3Macrone || 0);
                hospitalDispatch[d.hospital].filmA4Macrom += parseInt(d.filmA4Macrom || 0);
                hospitalDispatch[d.hospital].a4130GSM += parseInt(d.a4130GSM || 0);
                hospitalDispatch[d.hospital].a4Film210GSM += parseInt(d.a4Film210GSM || 0);
                hospitalDispatch[d.hospital].black += parseInt(d.black || 0);
                hospitalDispatch[d.hospital].yellow += parseInt(d.yellow || 0);
                hospitalDispatch[d.hospital].cyan += parseInt(d.cyan || 0);
                hospitalDispatch[d.hospital].megenta += parseInt(d.megenta || 0);
                hospitalDispatch[d.hospital].black500ml += parseInt(d.black500ml || 0);
                hospitalDispatch[d.hospital].garyInk += parseInt(d.garyInk || 0);
                hospitalDispatch[d.hospital].canonCyan += parseInt(d.canonCyan || 0);
                hospitalDispatch[d.hospital].canonMagenta += parseInt(d.canonMagenta || 0);
                hospitalDispatch[d.hospital].canonYellow += parseInt(d.canonYellow || 0);
                hospitalDispatch[d.hospital].canonGray += parseInt(d.canonGray || 0);
            });

            let dispatchHtml = '';
            Object.keys(hospitalDispatch).forEach(hospital => {
                const h = hospitalDispatch[hospital];
                const total = h.a4210 + h.a3210 + h.dispatch13x17Film + h.a4180 + h.film + h.film8x10Macron + h.filmA3Macrone + h.filmA4Macrom + h.a4130GSM + h.a4Film210GSM + h.black + h.yellow + h.cyan + h.megenta + h.black500ml + h.garyInk + h.canonCyan + h.canonMagenta + h.canonYellow + h.canonGray;
                dispatchHtml += `<tr><td class="bold-text">${hospital}</td><td>${h.location}</td><td>${h.a4210}</td><td>${h.a3210}</td><td>${h.dispatch13x17Film}</td><td>${h.a4180}</td><td>${h.film}</td><td>${h.film8x10Macron}</td><td>${h.filmA3Macrone}</td><td>${h.filmA4Macrom}</td><td>${h.a4130GSM}</td><td>${h.a4Film210GSM}</td><td>${h.black}</td><td>${h.yellow}</td><td>${h.cyan}</td><td>${h.megenta}</td><td>${h.black500ml}</td><td>${h.garyInk}</td><td>${h.canonCyan}</td><td>${h.canonMagenta}</td><td>${h.canonYellow}</td><td>${h.canonGray}</td><td class="total-column">${total}</td></tr>`;
            });
            document.getElementById('archiveDispatchTableBody').innerHTML = dispatchHtml || '<tr><td colspan="23" style="text-align:center; color:#999;">No data</td></tr>';

            document.getElementById('archiveDetailBox').classList.add('show');
        }

        // ADVANCED SEARCH FILTERS FOR ARCHIVE SECTION
        function filterArchiveStockTable() {
            const search = document.getElementById('archiveStockSearch').value.toLowerCase();
            const rows = document.getElementById('currentCreditStockTableBody').getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function filterArchiveStockTableAdvanced() {
            alert('üîç Live search activated! Real-time filter ho jaata hai!');
        }

        function filterArchiveDispatchTable() {
            const search = document.getElementById('archiveDispatchSearch').value.toLowerCase();
            const rows = document.getElementById('currentDispatchTableBody').getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function filterArchiveDispatchTableAdvanced() {
            alert('üîç Live search activated! Real-time filter ho jaata hai!');
        }

        function filterArchivedCreditTable() {
            const search = document.getElementById('archivedCreditSearch').value.toLowerCase();
            const rows = document.getElementById('archiveCreditStockTableBody').getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function filterArchivedCreditTableAdvanced() {
            alert('üîç Live search activated! Real-time filter ho jaata hai!');
        }

        function filterArchivedDispatchTable() {
            const search = document.getElementById('archivedDispatchSearch').value.toLowerCase();
            const rows = document.getElementById('archiveDispatchTableBody').getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
            });
        }

        function filterArchivedDispatchTableAdvanced() {
            alert('üîç Live search activated! Real-time filter ho jaata hai!');
        }

        function exportToExcel() {
            let csv = 'STOCK IN - RECEIVED\n';
            csv += 'Date,Month,A4-210 GSM,A3-210 GSM,13x17 Film,A4-180 GSM,8x10 Film,8x10 Macron,A3 Macrone,A4 Macrom,A4 130GSM,A4 Film 210GSM,Black Ink,Yellow Ink,Cyan Ink,Magenta Ink,500ML Black,Gary Ink,Canon Cyan,Canon Magenta,Canon Yellow,Canon Gray,Total,Notes\n';
            data.credits.forEach(c => {
                const rowTotal = calculateRowTotal(c);
                csv += `${c.date},${c.month},${c.a4210},${c.a3210},${c.credit13x17Film},${c.a4180},${c.film},${c.film8x10Macron},${c.filmA3Macrone},${c.filmA4Macrom},${c.a4130GSM},${c.a4Film210GSM},${c.black},${c.yellow},${c.cyan},${c.megenta},${c.black500ml},${c.garyInk},${c.canonCyan},${c.canonMagenta},${c.canonYellow},${c.canonGray},${rowTotal},"${c.remark}"\n`;
            });

            csv += '\n\nDISPATCH OUT - DELIVERED\n';
            csv += 'Date,Hospital Name,Location,A4-210 GSM,A3-210 GSM,13x17 Film,A4-180 GSM,8x10 Film,8x10 Macron,A3 Macrone,A4 Macrom,A4 130GSM,A4 Film 210GSM,Black Ink,Yellow Ink,Cyan Ink,Magenta Ink,500ML Black,Gary Ink,Canon Cyan,Canon Magenta,Canon Yellow,Canon Gray,Total\n';
            data.dispatches.forEach(d => {
                const rowTotal = Object.keys(d).reduce((sum, key) => {
                    if (key !== 'date' && key !== 'hospital' && key !== 'location') {
                        return sum + parseInt(d[key] || 0);
                    }
                    return sum;
                }, 0);
                csv += `${d.date},${d.hospital},${d.location},${d.a4210},${d.a3210},${d.dispatch13x17Film},${d.a4180},${d.film},${d.film8x10Macron},${d.filmA3Macrone},${d.filmA4Macrom},${d.a4130GSM},${d.a4Film210GSM},${d.black},${d.yellow},${d.cyan},${d.megenta},${d.black500ml},${d.garyInk},${d.canonCyan},${d.canonMagenta},${d.canonYellow},${d.canonGray},${rowTotal}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'MS_Stocks_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        // Export only visible rows from Stock IN history table (#incomingHistoryBody)
        function exportStockInToExcel() {
            try {
                const table = document.querySelector('#incomingHistorySection table');
                if (!table) return alert('Stock IN table not found');
                const thead = table.querySelector('thead');
                const headers = [];
                thead.querySelectorAll('th').forEach((th, i) => {
                    const txt = th.textContent.trim();
                    // Skip Action column (contains ‚öôÔ∏è or similar)
                    if (/action|‚öôÔ∏è|action/i.test(txt)) return;
                    headers.push(txt.replace(/\n/g, ' '));
                });

                const rows = Array.from(document.querySelectorAll('#incomingHistoryBody tr'));
                const filtered = rows.filter(r => {
                    const style = r.style.display;
                    if (style && style === 'none') return false;
                    // also check computed style
                    const cs = window.getComputedStyle(r);
                    return cs.display !== 'none';
                });

                if (filtered.length === 0) {
                    alert('No rows to export');
                    return;
                }

                let csv = '';
                csv += headers.join(',') + '\n';

                filtered.forEach(r => {
                    const cells = Array.from(r.querySelectorAll('td'));
                    // Exclude last cell (Action)
                    const dataCells = cells.slice(0, cells.length - 1);
                    const rowArr = dataCells.map(td => '"' + String(td.textContent || '').replace(/"/g, '""') + '"');
                    csv += rowArr.join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'StockInHistory_' + new Date().toISOString().split('T')[0] + '.csv';
                a.click();
            } catch (e) {
                console.error('exportStockInToExcel error', e);
                alert('Export failed');
            }
        }

        // Export only visible rows from Dispatch OUT history table (#outgoingHistoryBody)
        function exportDispatchOutToExcel() {
            try {
                const table = document.querySelector('#outgoingHistorySection table');
                if (!table) return alert('Dispatch OUT table not found');
                const thead = table.querySelector('thead');
                const headers = [];
                thead.querySelectorAll('th').forEach((th, i) => {
                    const txt = th.textContent.trim();
                    if (/action|‚öôÔ∏è|action/i.test(txt)) return;
                    headers.push(txt.replace(/\n/g, ' '));
                });

                const rows = Array.from(document.querySelectorAll('#outgoingHistoryBody tr'));
                const filtered = rows.filter(r => {
                    const style = r.style.display;
                    if (style && style === 'none') return false;
                    const cs = window.getComputedStyle(r);
                    return cs.display !== 'none';
                });

                if (filtered.length === 0) {
                    alert('No rows to export');
                    return;
                }

                let csv = '';
                csv += headers.join(',') + '\n';

                filtered.forEach(r => {
                    const cells = Array.from(r.querySelectorAll('td'));
                    // Exclude last cell (Action)
                    const dataCells = cells.slice(0, cells.length - 1);
                    const rowArr = dataCells.map(td => '"' + String(td.textContent || '').replace(/"/g, '""') + '"');
                    csv += rowArr.join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'DispatchOutHistory_' + new Date().toISOString().split('T')[0] + '.csv';
                a.click();
            } catch (e) {
                console.error('exportDispatchOutToExcel error', e);
                alert('Export failed');
            }
        }

        // Export only visible rows from Saved Hospitals table (#hospitalTable)
function exportHospitalsToExcel() {
    try {
        const table = document.getElementById('hospitalTable');
        if (!table) return alert('Hospital table not found');

        const thead = table.querySelector('thead');
        const headers = [];
        thead.querySelectorAll('th').forEach(th => {
            const txt = th.textContent.trim();
            // Skip Action column
            if (/action/i.test(txt)) return;
            headers.push(txt.replace(/\n/g, ' '));
        });

        const rows = Array.from(document.querySelectorAll('#hospitalTableBody tr'));
        const filtered = rows.filter(r => {
            const style = r.style.display;
            if (style && style === 'none') return false;
            const cs = window.getComputedStyle(r);
            return cs.display !== 'none';
        });

        if (filtered.length === 0) {
            alert('No rows to export');
            return;
        }

        let csv = '';
        csv += headers.join(',') + '\n';

        filtered.forEach(r => {
            const cells = Array.from(r.querySelectorAll('td'));
            // Exclude last cell (Action)
            const dataCells = cells.slice(0, cells.length - 1);
            const rowArr = dataCells.map(td => '"' + String(td.textContent || '').replace(/"/g, '""') + '"');
            csv += rowArr.join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Saved_Hospitals_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
    } catch (e) {
        console.error('exportHospitalsToExcel error', e);
        alert('Export failed');
    }
}

        // COUNTER FUNCTIONS
        function updateCounterHospitalDropdown() {
            const sel = document.getElementById('ctrHospital');
            sel.innerHTML = '<option value="">-- Select Hospital --</option>';
            
            // Add predefined options first
            sel.innerHTML += '<option value="City Hospital">City Hospital</option>';
            sel.innerHTML += '<option value="Apollo Clinic">Apollo Clinic</option>';
            sel.innerHTML += '<option value="Medcare Center">Medcare Center</option>';
            sel.innerHTML += '<option value="Other">Other (Custom Name)</option>';
            
            // Add hospitals from the hospital list
            data.hospitals.forEach(h => {
                sel.innerHTML += `<option value="${h.name}">${h.name}</option>`;
            });
        }
        
        function updateCounterHospitalFilter() {
            const sel = document.getElementById('ctrFilterHospital');
            if (!sel) return;

            // Default option
            sel.innerHTML = '<option value="">All Hospitals</option>';

            // meterCounters me jitne hospital use hue hain, unka unique list
            const used = new Set();
            meterCounters.forEach(r => {
                if (r.hospital && !used.has(r.hospital)) {
                    used.add(r.hospital);
                    sel.innerHTML += `<option value="${r.hospital}">${r.hospital}</option>`;
                }
            });
        }

        function handleCounterHospitalChange() {
            const sel = document.getElementById('ctrHospital');
            const custom = document.getElementById('ctrHospitalCustom');
            const modelInput = document.getElementById('ctrPrinterModel');
            const serialInput = document.getElementById('ctrPrinterSerial');
            
            const selectedHospital = sel.value;
            
            if (selectedHospital === 'Other') {
                custom.disabled = false;
                custom.focus();
                // Clear printer fields
                modelInput.value = '';
                serialInput.value = '';
            } else {
                custom.value = '';
                custom.disabled = true;
                
                // Find hospital in data and fill printer details
                const hospital = data.hospitals.find(h => h.name === selectedHospital);
                if (hospital) {
                    modelInput.value = hospital.printer;
                    serialInput.value = hospital.serial;
                } else {
                    // Clear fields if hospital not found
                    modelInput.value = '';
                    serialInput.value = '';
                }
            }
            
            fillOpeningFromPrevious();
        }

        function initCounterPage() {
            // Set up event listeners for counter
            const ctrHosp = document.getElementById('ctrHospital');
            const ctrHospCustom = document.getElementById('ctrHospitalCustom');
            
            // Update hospital dropdown
            updateCounterHospitalDropdown();
            
            if (ctrHosp && ctrHospCustom) {
                ctrHosp.addEventListener('change', () => {
                    handleCounterHospitalChange();
                });
            }

            const ctrMonth = document.getElementById('ctrMonth');
            if (ctrMonth) ctrMonth.addEventListener('change', fillOpeningFromPrevious);

            const printerModelInput = document.getElementById('ctrPrinterModel');
            const printerSerialInput = document.getElementById('ctrPrinterSerial');
            if (printerModelInput) printerModelInput.addEventListener('input', fillOpeningFromPrevious);
            if (printerSerialInput) printerSerialInput.addEventListener('input', fillOpeningFromPrevious);

            [
                'ctrCloseA4','ctrCloseA3','ctrClose13','ctrClose8x10',
                'ctrOpenOther1','ctrCloseOther1',
                'ctrOpenOther2','ctrCloseOther2',
                'ctrOpenOther3','ctrCloseOther3'
            ].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', recalcMeterUsed);
            });

            document.getElementById('ctrBtnSave').addEventListener('click', addOrUpdateMeterCounter);
            document.getElementById('ctrBtnClear').addEventListener('click', () => clearMeterForm(true));
            document.getElementById('ctrBtnShow').addEventListener('click', applyMeterFilter);
            document.getElementById('ctrBtnExport').addEventListener('click', exportCounterAsPDF);

            const toggleBtn = document.getElementById('toggleOthersBtn');
            if (toggleBtn) toggleBtn.addEventListener('click', toggleOtherOptions);

            fillOpeningFromPrevious();
            updateCounterTable();
        }

        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('ctrAlert');
            if (!alertBox) return;
            alertBox.className = 'alert ' + (type === 'error' ? 'alert-error' : 'alert-success');
            alertBox.textContent = message;
        }

        function getHospitalName(prefix) {
            if (prefix === 'ctr') {
                const sel = document.getElementById('ctrHospital');
                const custom = document.getElementById('ctrHospitalCustom');
                if (!sel) return '';
                const val = sel.value;
                if (val === 'Other') return (custom.value || '').trim();
                return val;
            }
            
            // For other prefixes (like dispatch, parts), keep existing logic
            const sel = document.getElementById(prefix + 'Hospital');
            const custom = document.getElementById(prefix + 'HospitalCustom');
            if (!sel) return '';
            const val = sel.value;
            if (val === 'Other') return (custom.value || '').trim();
            return val;
        }

        function getPrinterKey(model, serial) {
            return (model || '').trim() + '|' + (serial || '').trim();
        }

        function findPreviousMonthRecord(month, hospital, printerKey) {
            let list = meterCounters.filter((e, idx) => {
                if (idx === currentEditIndex) return false;
                const key = getPrinterKey(e.printerModel, e.printerSerial);
                return e.hospital === hospital && key === printerKey && e.month < month;
            });
            if (!list.length) return null;
            list.sort((a, b) => a.month.localeCompare(b.month));
            return list[list.length - 1];
        }

        function fillOpeningFromPrevious() {
            if (isEditing) return;
            const month = document.getElementById('ctrMonth').value;
            const hospital = getHospitalName('ctr');
            const model = document.getElementById('ctrPrinterModel').value;
            const serial = document.getElementById('ctrPrinterSerial').value;
            const printerKey = getPrinterKey(model, serial);

            const openA4 = document.getElementById('ctrOpenA4');
            const openA3 = document.getElementById('ctrOpenA3');
            const open13 = document.getElementById('ctrOpen13');
            const open8 = document.getElementById('ctrOpen8x10');

            if (!month || !hospital || !printerKey.trim()) {
                openA4.value = openA3.value = open13.value = open8.value = 0;
                recalcMeterUsed();
                return;
            }

            const prev = findPreviousMonthRecord(month, hospital, printerKey);
            if (prev) {
                openA4.value = prev.closeA4;
                openA3.value = prev.closeA3;
                open13.value = prev.close13;
                open8.value = prev.close8x10;
            } else {
                openA4.value = openA3.value = open13.value = open8.value = 0;
            }
            recalcMeterUsed();
        }

        function recalcMeterUsed() {
            const openA4 = parseInt(document.getElementById('ctrOpenA4').value || 0);
            const openA3 = parseInt(document.getElementById('ctrOpenA3').value || 0);
            const open13 = parseInt(document.getElementById('ctrOpen13').value || 0);
            const open8 = parseInt(document.getElementById('ctrOpen8x10').value || 0);

            const closeA4 = parseInt(document.getElementById('ctrCloseA4').value || 0);
            const closeA3 = parseInt(document.getElementById('ctrCloseA3').value || 0);
            const close13 = parseInt(document.getElementById('ctrClose13').value || 0);
            const close8 = parseInt(document.getElementById('ctrClose8x10').value || 0);

            let usedA4 = closeA4 - openA4;
            let usedA3 = closeA3 - openA3;
            let used13 = close13 - open13;
            let used8 = close8 - open8;

            if (usedA4 < 0) usedA4 = 0;
            if (usedA3 < 0) usedA3 = 0;
            if (used13 < 0) used13 = 0;
            if (used8 < 0) used8 = 0;

            document.getElementById('ctrUsedA4').value = usedA4;
            document.getElementById('ctrUsedA3').value = usedA3;
            document.getElementById('ctrUsed13').value = used13;
            document.getElementById('ctrUsed8x10').value = used8;

            const o1Open = parseInt(document.getElementById('ctrOpenOther1').value || 0);
            const o1Close = parseInt(document.getElementById('ctrCloseOther1').value || 0);
            const o2Open = parseInt(document.getElementById('ctrOpenOther2').value || 0);
            const o2Close = parseInt(document.getElementById('ctrCloseOther2').value || 0);
            const o3Open = parseInt(document.getElementById('ctrOpenOther3').value || 0);
            const o3Close = parseInt(document.getElementById('ctrCloseOther3').value || 0);

            let usedO1 = o1Close - o1Open;
            let usedO2 = o2Close - o2Open;
            let usedO3 = o3Close - o3Open;

            if (usedO1 < 0) usedO1 = 0;
            if (usedO2 < 0) usedO2 = 0;
            if (usedO3 < 0) usedO3 = 0;

            document.getElementById('ctrUsedOther1').value = usedO1;
            document.getElementById('ctrUsedOther2').value = usedO2;
            document.getElementById('ctrUsedOther3').value = usedO3;

            const totalUsed = usedA4 + usedA3 + used13 + used8 + usedO1 + usedO2 + usedO3;
            document.getElementById('ctrUsedTotal').value = totalUsed;
        }

        function addOrUpdateMeterCounter() {
            const month = document.getElementById('ctrMonth').value;
            const hospital = getHospitalName('ctr');
            const printerModel = document.getElementById('ctrPrinterModel').value.trim();
            const printerSerial = document.getElementById('ctrPrinterSerial').value.trim();

            if (!month) return showAlert('Month is required.', 'error');
            if (!hospital) return showAlert('Please select or enter a hospital.', 'error');
            if (!printerModel || !printerSerial) {
                return showAlert('Please enter Printer Model and Serial No.', 'error');
            }

            const openA4 = parseInt(document.getElementById('ctrOpenA4').value || 0);
            const openA3 = parseInt(document.getElementById('ctrOpenA3').value || 0);
            const open13 = parseInt(document.getElementById('ctrOpen13').value || 0);
            const open8 = parseInt(document.getElementById('ctrOpen8x10').value || 0);

            const closeA4 = parseInt(document.getElementById('ctrCloseA4').value || 0);
            const closeA3 = parseInt(document.getElementById('ctrCloseA3').value || 0);
            const close13 = parseInt(document.getElementById('ctrClose13').value || 0);
            const close8 = parseInt(document.getElementById('ctrClose8x10').value || 0);

            if (closeA4 < openA4 || closeA3 < openA3 || close13 < open13 || close8 < open8) {
                return showAlert('Closing counter cannot be smaller than Opening.', 'error');
            }

            const usedA4 = parseInt(document.getElementById('ctrUsedA4').value || 0);
            const usedA3 = parseInt(document.getElementById('ctrUsedA3').value || 0);
            const used13 = parseInt(document.getElementById('ctrUsed13').value || 0);
            const used8 = parseInt(document.getElementById('ctrUsed8x10').value || 0);

            const other1Name = document.getElementById('ctrOther1Name').value || '';
            const other2Name = document.getElementById('ctrOther2Name').value || '';
            const other3Name = document.getElementById('ctrOther3Name').value || '';

            const openO1 = parseInt(document.getElementById('ctrOpenOther1').value || 0);
            const closeO1 = parseInt(document.getElementById('ctrCloseOther1').value || 0);
            const usedO1 = parseInt(document.getElementById('ctrUsedOther1').value || 0);

            const openO2 = parseInt(document.getElementById('ctrOpenOther2').value || 0);
            const closeO2 = parseInt(document.getElementById('ctrCloseOther2').value || 0);
            const usedO2 = parseInt(document.getElementById('ctrUsedOther2').value || 0);

            const openO3 = parseInt(document.getElementById('ctrOpenOther3').value || 0);
            const closeO3 = parseInt(document.getElementById('ctrCloseOther3').value || 0);
            const usedO3 = parseInt(document.getElementById('ctrUsedOther3').value || 0);

            const totalUsed = usedA4 + usedA3 + used13 + used8 + usedO1 + usedO2 + usedO3;

            const record = {
                month,
                hospital,
                printerModel,
                printerSerial,
                openA4, closeA4, usedA4,
                openA3, closeA3, usedA3,
                open13, close13, used13,
                open8x10: open8, close8x10: close8, used8x10: used8,
                other1Name, openO1, closeO1, usedO1,
                other2Name, openO2, closeO2, usedO2,
                other3Name, openO3, closeO3, usedO3,
                totalUsed
            };

            // key: month + hospital + printer
            const printerKey = getPrinterKey(printerModel, printerSerial);

            if (currentEditIndex >= 0) {
                meterCounters[currentEditIndex] = record;
                showAlert('Counter entry updated.', 'success');
            } else {
                const existingIndex = meterCounters.findIndex(e =>
                    e.month === month &&
                    e.hospital === hospital &&
                    getPrinterKey(e.printerModel, e.printerSerial) === printerKey
                );
                if (existingIndex >= 0) {
                    meterCounters[existingIndex] = record;
                    showAlert('Counter entry updated (same month + hospital + printer).', 'success');
                } else {
                    meterCounters.push(record);
                    showAlert('Counter entry saved.', 'success');
                }
            }

            saveMeterCounters();
            updateCounterTable();
            updateCounterHospitalFilter();
            currentEditIndex = -1;
            isEditing = false;
        }

        function clearOtherFields() {
            [
                'ctrOther1Name','ctrOpenOther1','ctrCloseOther1','ctrUsedOther1',
                'ctrOther2Name','ctrOpenOther2','ctrCloseOther2','ctrUsedOther2',
                'ctrOther3Name','ctrOpenOther3','ctrCloseOther3','ctrUsedOther3'
            ].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            recalcMeterUsed();
        }

        function clearMeterForm(resetMonth = true) {
            currentEditIndex = -1;
            isEditing = false;

            if (resetMonth) {
                const month = new Date().toISOString().slice(0, 7);
                document.getElementById('ctrMonth').value = month;
            }

            ['ctrOpenA4','ctrOpenA3','ctrOpen13','ctrOpen8x10',
             'ctrCloseA4','ctrCloseA3','ctrClose13','ctrClose8x10',
             'ctrUsedA4','ctrUsedA3','ctrUsed13','ctrUsed8x10',
             'ctrUsedTotal',
             'ctrPrinterModel','ctrPrinterSerial'
            ].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            clearOtherFields();

            const sel = document.getElementById('ctrHospital');
            const custom = document.getElementById('ctrHospitalCustom');
            if (sel) sel.value = '';
            if (custom) { custom.value = ''; custom.disabled = true; }
        }

        function getMeterFiltered(fromMonth, toMonth, filterHospital) {
            let list = [...meterCounters];
            if (fromMonth) list = list.filter(e => e.month >= fromMonth);
            if (toMonth) list = list.filter(e => e.month <= toMonth);
            if (filterHospital) list = list.filter(e => e.hospital === filterHospital);
            list.sort((a, b) => a.month.localeCompare(b.month));
            return list;
        }

        function applyMeterFilter() {
            const from = document.getElementById('ctrFilterMonthFrom').value;
            const to = document.getElementById('ctrFilterMonthTo').value;
            const hospitalSelect = document.getElementById('ctrFilterHospital');
            let hospital = hospitalSelect.value;

            if (hospital === 'Other') hospital = null;

            updateCounterTable(from || null, to || null, hospital || null);
        }

        function editMeterCounter(index) {
            const r = meterCounters[index];
            if (!r) return;
            isEditing = true;
            currentEditIndex = index;

            document.getElementById('ctrMonth').value = r.month;

            const sel = document.getElementById('ctrHospital');
            const custom = document.getElementById('ctrHospitalCustom');

            if (sel) {
                if (['City Hospital','Apollo Clinic','Medcare Center'].includes(r.hospital)) {
                    sel.value = r.hospital;
                    if (custom) { custom.value = ''; custom.disabled = true; }
                } else {
                    sel.value = 'Other';
                    if (custom) { custom.value = r.hospital; custom.disabled = false; }
                }
            }

            document.getElementById('ctrPrinterModel').value = r.printerModel || '';
            document.getElementById('ctrPrinterSerial').value = r.printerSerial || '';

            document.getElementById('ctrOpenA4').value = r.openA4;
            document.getElementById('ctrCloseA4').value = r.closeA4;
            document.getElementById('ctrUsedA4').value = r.usedA4;

            document.getElementById('ctrOpenA3').value = r.openA3;
            document.getElementById('ctrCloseA3').value = r.closeA3;
            document.getElementById('ctrUsedA3').value = r.usedA3;

            document.getElementById('ctrOpen13').value = r.open13;
            document.getElementById('ctrClose13').value = r.close13;
            document.getElementById('ctrUsed13').value = r.used13;

            document.getElementById('ctrOpen8x10').value = r.open8x10;
            document.getElementById('ctrClose8x10').value = r.close8x10;
            document.getElementById('ctrUsed8x10').value = r.used8x10;

            document.getElementById('ctrOther1Name').value = r.other1Name || '';
            document.getElementById('ctrOpenOther1').value = r.openO1;
            document.getElementById('ctrCloseOther1').value = r.closeO1;
            document.getElementById('ctrUsedOther1').value = r.usedO1;

            document.getElementById('ctrOther2Name').value = r.other2Name || '';
            document.getElementById('ctrOpenOther2').value = r.openO2;
            document.getElementById('ctrCloseOther2').value = r.closeO2;
            document.getElementById('ctrUsedOther2').value = r.usedO2;

            document.getElementById('ctrOther3Name').value = r.other3Name || '';
            document.getElementById('ctrOpenOther3').value = r.openO3;
            document.getElementById('ctrCloseOther3').value = r.closeO3;
            document.getElementById('ctrUsedOther3').value = r.usedO3;

            document.getElementById('ctrUsedTotal').value = r.totalUsed;

            const block = document.getElementById('otherOptionsBlock');
            const toggleBtn = document.getElementById('toggleOthersBtn');
            if (block && toggleBtn) {
                block.style.display = 'block';
                toggleBtn.textContent = '‚ûñ Hide Other Options';
            }

            showAlert('Edit mode: you can change values and click Save / Update.', 'success');
        }

        function updateCounterTable(fromMonth = null, toMonth = null, filterHospital = null) {
            const tbody = document.getElementById('ctrTableBody');
            const list = getMeterFiltered(fromMonth, toMonth, filterHospital);

            let totalA4 = 0, totalA3 = 0, total13 = 0, total8 = 0;
            let totalO1 = 0, totalO2 = 0, totalO3 = 0, totalUsed = 0;

            if (!list.length) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align:center; color:#9ca3af;">No data found</td></tr>';
            } else {
                tbody.innerHTML = '';
                list.forEach((e, idx) => {
                    totalA4 += e.usedA4;
                    totalA3 += e.usedA3;
                    total13 += e.used13;
                    total8 += e.used8x10;
                    totalO1 += e.usedO1;
                    totalO2 += e.usedO2;
                    totalO3 += e.usedO3;
                    totalUsed += e.totalUsed;

                    tbody.innerHTML += `
                        <tr>
                            <td>${e.month}</td>
                            <td>${e.hospital}</td>
                            <td>${e.printerModel || ''}</td>
                            <td>${e.printerSerial || ''}</td>
                            <td>${e.usedA4}</td>
                            <td>${e.usedA3}</td>
                            <td>${e.used13}</td>
                            <td>${e.used8x10}</td>
                            <td>${e.usedO1}</td>
                            <td>${e.usedO2}</td>
                            <td>${e.usedO3}</td>
                            <td class="total-column">${e.totalUsed}</td>
                            <td><button class="btn-secondary" onclick="editMeterCounter(${meterCounters.indexOf(e)})">Edit</button></td>
                        </tr>`;
                });
            }

            document.getElementById('ctrTotalA4').innerText = totalA4;
            document.getElementById('ctrTotalA3').innerText = totalA3;
            document.getElementById('ctrTotal13').innerText = total13;
            document.getElementById('ctrTotal8x10').innerText = total8;
            document.getElementById('ctrTotalOther1').innerText = totalO1;
            document.getElementById('ctrTotalOther2').innerText = totalO2;
            document.getElementById('ctrTotalOther3').innerText = totalO3;
            document.getElementById('ctrTotalUsed').innerText = totalUsed;
        }

        function exportCounterAsPDF() {
            const table = document.getElementById('ctrTable');
            if (!table) return;

            const from = document.getElementById('ctrFilterMonthFrom').value;
            const to = document.getElementById('ctrFilterMonthTo').value;
            const hospitalSelect = document.getElementById('ctrFilterHospital');
            const hospitalText = hospitalSelect.options[hospitalSelect.selectedIndex].text || 'All Hospitals';

            // clone table and remove last (Action) column
            const clonedTable = table.cloneNode(true);
            for (let i = 0; i < clonedTable.rows.length; i++) {
                const row = clonedTable.rows[i];
                if (row.cells.length > 0) {
                    row.deleteCell(row.cells.length - 1);
                }
            }

            const win = window.open('', '_blank');
            if (!win) {
                alert('Popup blocked. Please allow popups to export PDF.');
                return;
            }

            const title = 'Counter Report (Month Range + Hospital + Printer)';
            const subtitle = `
                <div style="font-size:13px; color:#555; margin-bottom:8px;">
                    <div><strong>From Month:</strong> ${from || 'All'}</div>
                    <div><strong>To Month:</strong> ${to || 'All'}</div>
                    <div><strong>Hospital Filter:</strong> ${hospitalText}</div>
                </div>
            `;

            win.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 13px;
                            color: #111827;
                            padding: 16px;
                        }
                        h1 {
                            font-size: 20px;
                            margin-bottom: 4px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                            font-size: 12px;
                        }
                        th, td {
                            border: 1px solid #e5e7eb;
                            padding: 4px 6px;
                            text-align: right;
                        }
                        th:nth-child(1),
                        td:nth-child(1),
                        th:nth-child(2),
                        td:nth-child(2),
                        th:nth-child(3),
                        td:nth-child(3),
                        th:nth-child(4),
                        td:nth-child(4) {
                            text-align: left;
                        }
                        thead {
                            background: #e5edff;
                        }
                        tfoot td {
                            font-weight: bold;
                            background: #eef2ff;
                        }
                        .total-column {
                            background: #fef9c3;
                        }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${subtitle}
                    ${clonedTable.outerHTML}
                </body>
                </html>
            `);

            win.document.close();
            win.focus();
            setTimeout(() => {
                win.print();
                win.close();
            }, 400);
        }

        function toggleOtherOptions() {
            const block = document.getElementById('otherOptionsBlock');
            const btn = document.getElementById('toggleOthersBtn');
            if (!block || !btn) return;

            if (block.style.display === 'none' || block.style.display === '') {
                block.style.display = 'block';
                btn.textContent = '‚ûñ Hide Other Options';
            } else {
                block.style.display = 'none';
                btn.textContent = '‚ûï Show Other Options';
                clearOtherFields();
            }
        }
    </script>
    <script src="full_script.js"></script>
</body>
</html>